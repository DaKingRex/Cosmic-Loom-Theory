

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../../">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>visualizations.interactive.loomfield_3d_realtime &mdash; Cosmic Loom Theory Documentation</title>
      <link rel="stylesheet" type="text/css" href="../../../_static/pygments.css?v=b86133f3" />
      <link rel="stylesheet" type="text/css" href="../../../_static/css/theme.css?v=9edc463e" />
      <link rel="stylesheet" type="text/css" href="../../../_static/copybutton.css?v=76b2166b" />
      <link rel="stylesheet" type="text/css" href="../../../_static/custom.css?v=0c5202d4" />

  
      <script src="../../../_static/jquery.js?v=5d32c60e"></script>
      <script src="../../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="../../../_static/documentation_options.js?v=56dcb7b8"></script>
      <script src="../../../_static/doctools.js?v=9a2dae69"></script>
      <script src="../../../_static/sphinx_highlight.js?v=dc90522c"></script>
      <script src="../../../_static/clipboard.min.js?v=a7894cd8"></script>
      <script src="../../../_static/copybutton.js?v=f281be69"></script>
    <script src="../../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../../index.html" class="icon icon-home">
            Cosmic Loom Theory
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Getting Started</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../installation.html">Installation</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../installation.html#requirements">Requirements</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../installation.html#core-dependencies">Core Dependencies</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../installation.html#optional-dependencies">Optional Dependencies</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../installation.html#installation-methods">Installation Methods</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../installation.html#from-source-recommended">From Source (Recommended)</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../installation.html#minimal-installation">Minimal Installation</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../installation.html#real-time-3d-visualizer">Real-Time 3D Visualizer</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../installation.html#verifying-installation">Verifying Installation</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../installation.html#troubleshooting">Troubleshooting</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../quickstart.html">Quick Start Guide</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../quickstart.html#energy-resistance-visualizer">Energy Resistance Visualizer</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../quickstart.html#d-loomfield-simulator">2D Loomfield Simulator</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../quickstart.html#d-loomfield-visualizer">3D Loomfield Visualizer</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../quickstart.html#real-time-3d-simulator">Real-Time 3D Simulator</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../quickstart.html#understanding-the-metrics">Understanding the Metrics</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../quickstart.html#preset-scenarios">Preset Scenarios</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../quickstart.html#next-steps">Next Steps</a></li>
</ul>
</li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Theory</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../theory/index.html">Theoretical Background</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../theory/index.html#core-framework-clt-v1-1">Core Framework: CLT v1.1</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../theory/index.html#the-loomfield">The Loomfield</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../theory/index.html#energy-resistance">Energy Resistance</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../theory/index.html#consciousness-observable">Consciousness Observable</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../theory/index.html#biological-substrates">Biological Substrates</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../theory/index.html#related-theoretical-documents">Related Theoretical Documents</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../theory/index.html#connections-to-other-theories">Connections to Other Theories</a></li>
</ul>
</li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Tutorials</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../tutorials/index.html">Tutorials</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../tutorials/index.html#getting-started">Getting Started</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../tutorials/index.html#basic-simulation-tutorial">Basic Simulation Tutorial</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../tutorials/index.html#understanding-the-metrics">Understanding the Metrics</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../tutorials/index.html#creating-custom-presets">Creating Custom Presets</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../tutorials/index.html#d-simulations">3D Simulations</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../tutorials/index.html#perturbations-and-healing">Perturbations and Healing</a></li>
</ul>
</li>
</ul>
<p class="caption" role="heading"><span class="caption-text">API Reference</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../api/index.html">API Reference</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../api/index.html#simulators">Simulators</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../api/_autosummary/visualizations.interactive.loomfield_wave.LoomfieldSimulator.html">visualizations.interactive.loomfield_wave.LoomfieldSimulator</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../api/_autosummary/visualizations.interactive.loomfield_wave.LoomfieldSimulator.html#visualizations.interactive.loomfield_wave.LoomfieldSimulator"><code class="docutils literal notranslate"><span class="pre">LoomfieldSimulator</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../api/_autosummary/visualizations.interactive.loomfield_3d.LoomfieldSimulator3D.html">visualizations.interactive.loomfield_3d.LoomfieldSimulator3D</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../api/_autosummary/visualizations.interactive.loomfield_3d.LoomfieldSimulator3D.html#visualizations.interactive.loomfield_3d.LoomfieldSimulator3D"><code class="docutils literal notranslate"><span class="pre">LoomfieldSimulator3D</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../api/_autosummary/visualizations.interactive.loomfield_3d_realtime.LoomfieldSimulator3DRealtime.html">visualizations.interactive.loomfield_3d_realtime.LoomfieldSimulator3DRealtime</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../api/_autosummary/visualizations.interactive.loomfield_3d_realtime.LoomfieldSimulator3DRealtime.html#visualizations.interactive.loomfield_3d_realtime.LoomfieldSimulator3DRealtime"><code class="docutils literal notranslate"><span class="pre">LoomfieldSimulator3DRealtime</span></code></a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../api/index.html#visualizers">Visualizers</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../api/_autosummary/visualizations.interactive.energy_resistance.EnergyResistanceVisualizer.html">visualizations.interactive.energy_resistance.EnergyResistanceVisualizer</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../api/_autosummary/visualizations.interactive.energy_resistance.EnergyResistanceVisualizer.html#visualizations.interactive.energy_resistance.EnergyResistanceVisualizer"><code class="docutils literal notranslate"><span class="pre">EnergyResistanceVisualizer</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../api/_autosummary/visualizations.interactive.loomfield_wave.LoomfieldVisualizer.html">visualizations.interactive.loomfield_wave.LoomfieldVisualizer</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../api/_autosummary/visualizations.interactive.loomfield_wave.LoomfieldVisualizer.html#visualizations.interactive.loomfield_wave.LoomfieldVisualizer"><code class="docutils literal notranslate"><span class="pre">LoomfieldVisualizer</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../api/_autosummary/visualizations.interactive.loomfield_3d.LoomfieldVisualizer3D.html">visualizations.interactive.loomfield_3d.LoomfieldVisualizer3D</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../api/_autosummary/visualizations.interactive.loomfield_3d.LoomfieldVisualizer3D.html#visualizations.interactive.loomfield_3d.LoomfieldVisualizer3D"><code class="docutils literal notranslate"><span class="pre">LoomfieldVisualizer3D</span></code></a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../api/index.html#core-classes">Core Classes</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../api/index.html#loomfieldsimulator-2d">LoomfieldSimulator (2D)</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../api/index.html#visualizations.interactive.loomfield_wave.LoomfieldSimulator"><code class="docutils literal notranslate"><span class="pre">LoomfieldSimulator</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../api/index.html#loomfieldsimulator3d">LoomfieldSimulator3D</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../api/index.html#visualizations.interactive.loomfield_3d.LoomfieldSimulator3D"><code class="docutils literal notranslate"><span class="pre">LoomfieldSimulator3D</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../api/index.html#energyresistancevisualizer">EnergyResistanceVisualizer</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../api/index.html#visualizations.interactive.energy_resistance.EnergyResistanceVisualizer"><code class="docutils literal notranslate"><span class="pre">EnergyResistanceVisualizer</span></code></a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../api/index.html#utility-functions">Utility Functions</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../api/index.html#energy-resistance">Energy Resistance</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../api/index.html#visualizations.interactive.energy_resistance.calculate_system_er"><code class="docutils literal notranslate"><span class="pre">calculate_system_er()</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../api/index.html#d-visualization">3D Visualization</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../api/index.html#visualizations.interactive.loomfield_3d.create_volumetric_figure"><code class="docutils literal notranslate"><span class="pre">create_volumetric_figure()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api/index.html#visualizations.interactive.loomfield_3d.create_slice_figure"><code class="docutils literal notranslate"><span class="pre">create_slice_figure()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api/index.html#visualizations.interactive.loomfield_3d.create_animated_figure"><code class="docutils literal notranslate"><span class="pre">create_animated_figure()</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../api/index.html#preset-functions">Preset Functions</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../api/index.html#visualizations.interactive.loomfield_3d.create_healthy_preset"><code class="docutils literal notranslate"><span class="pre">create_healthy_preset()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api/index.html#visualizations.interactive.loomfield_3d.create_pathology_preset"><code class="docutils literal notranslate"><span class="pre">create_pathology_preset()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api/index.html#visualizations.interactive.loomfield_3d.create_healing_preset"><code class="docutils literal notranslate"><span class="pre">create_healing_preset()</span></code></a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../api/index.html#module-reference">Module Reference</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../api/index.html#module-visualizations.interactive">visualizations.interactive</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../api/index.html#visualizations.interactive.EnergyResistanceVisualizer"><code class="docutils literal notranslate"><span class="pre">EnergyResistanceVisualizer</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api/index.html#visualizations.interactive.calculate_system_er"><code class="docutils literal notranslate"><span class="pre">calculate_system_er()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api/index.html#visualizations.interactive.energy_resistance_demo"><code class="docutils literal notranslate"><span class="pre">energy_resistance_demo()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api/index.html#visualizations.interactive.LoomfieldSimulator"><code class="docutils literal notranslate"><span class="pre">LoomfieldSimulator</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api/index.html#visualizations.interactive.LoomfieldVisualizer"><code class="docutils literal notranslate"><span class="pre">LoomfieldVisualizer</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api/index.html#visualizations.interactive.loomfield_demo"><code class="docutils literal notranslate"><span class="pre">loomfield_demo()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api/index.html#visualizations.interactive.LoomfieldSimulator3D"><code class="docutils literal notranslate"><span class="pre">LoomfieldSimulator3D</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api/index.html#visualizations.interactive.LoomfieldVisualizer3D"><code class="docutils literal notranslate"><span class="pre">LoomfieldVisualizer3D</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api/index.html#visualizations.interactive.create_volumetric_figure"><code class="docutils literal notranslate"><span class="pre">create_volumetric_figure()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api/index.html#visualizations.interactive.create_slice_figure"><code class="docutils literal notranslate"><span class="pre">create_slice_figure()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api/index.html#visualizations.interactive.create_animated_figure"><code class="docutils literal notranslate"><span class="pre">create_animated_figure()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api/index.html#visualizations.interactive.create_healthy_preset"><code class="docutils literal notranslate"><span class="pre">create_healthy_preset()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api/index.html#visualizations.interactive.create_pathology_preset"><code class="docutils literal notranslate"><span class="pre">create_pathology_preset()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api/index.html#visualizations.interactive.create_healing_preset"><code class="docutils literal notranslate"><span class="pre">create_healing_preset()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api/index.html#visualizations.interactive.loomfield_3d_demo"><code class="docutils literal notranslate"><span class="pre">loomfield_3d_demo()</span></code></a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Development</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../contributing.html">Contributing</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../contributing.html#getting-started">Getting Started</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../contributing.html#development-workflow">Development Workflow</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../contributing.html#running-tests">Running Tests</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../contributing.html#code-style">Code Style</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../contributing.html#building-documentation">Building Documentation</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../contributing.html#types-of-contributions">Types of Contributions</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../contributing.html#pull-request-guidelines">Pull Request Guidelines</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../contributing.html#questions">Questions?</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../changelog.html">Changelog</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../changelog.html#id1">[1.1.0] - 2025-01-26</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../changelog.html#added">Added</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../changelog.html#fixed">Fixed</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../changelog.html#id2">[1.0.0] - 2025-01-25</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../changelog.html#id3">Added</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../changelog.html#planned">Planned</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../changelog.html#future">[1.2.0] - Future</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../changelog.html#id4">[2.0.0] - Future</a></li>
</ul>
</li>
</ul>
</li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">Cosmic Loom Theory</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content style-external-links">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../../index.html">Module code</a></li>
      <li class="breadcrumb-item active">visualizations.interactive.loomfield_3d_realtime</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for visualizations.interactive.loomfield_3d_realtime</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Real-Time 3D Loomfield Simulator</span>

<span class="sd">An interactive 3D visualization of Loomfield dynamics with real-time physics</span>
<span class="sd">computation and rendering. This is the 3D extension of loomfield_wave.py.</span>

<span class="sd">Wave Equation (3D):</span>
<span class="sd">    ∇²L - (1/v²ₗ)(∂²L/∂t²) = κₗ · ρ_coh</span>

<span class="sd">Features:</span>
<span class="sd">    - Real-time 3D wave propagation</span>
<span class="sd">    - Volumetric rendering with gold/blue colormap</span>
<span class="sd">    - Interactive mouse rotation</span>
<span class="sd">    - Sliders for v_L, κ_L, animation speed</span>
<span class="sd">    - Preset buttons: Healthy, Pathology, Healing</span>
<span class="sd">    - Click modes: Add Source, Add Perturbation</span>
<span class="sd">    - Slice plane to view interior structure</span>

<span class="sd">Requirements:</span>
<span class="sd">    pip install vispy PyQt5 numpy scipy</span>

<span class="sd">Usage:</span>
<span class="sd">    python run_loomfield_3d_realtime.py</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">scipy.ndimage</span><span class="w"> </span><span class="kn">import</span> <span class="n">gaussian_filter</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">List</span><span class="p">,</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Tuple</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">warnings</span>
<span class="n">warnings</span><span class="o">.</span><span class="n">filterwarnings</span><span class="p">(</span><span class="s1">&#39;ignore&#39;</span><span class="p">)</span>

<span class="c1"># Try to import vispy and Qt</span>
<span class="k">try</span><span class="p">:</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">vispy</span><span class="w"> </span><span class="kn">import</span> <span class="n">app</span><span class="p">,</span> <span class="n">scene</span><span class="p">,</span> <span class="n">color</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">vispy.scene</span><span class="w"> </span><span class="kn">import</span> <span class="n">visuals</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">vispy.visuals.transforms</span><span class="w"> </span><span class="kn">import</span> <span class="n">STTransform</span><span class="p">,</span> <span class="n">MatrixTransform</span>
    <span class="n">HAS_VISPY</span> <span class="o">=</span> <span class="kc">True</span>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
    <span class="n">HAS_VISPY</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;vispy not found. Install with: pip install vispy PyQt5&quot;</span><span class="p">)</span>

<span class="k">try</span><span class="p">:</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">PyQt5</span><span class="w"> </span><span class="kn">import</span> <span class="n">QtWidgets</span><span class="p">,</span> <span class="n">QtCore</span><span class="p">,</span> <span class="n">QtGui</span>
    <span class="n">HAS_QT</span> <span class="o">=</span> <span class="kc">True</span>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
    <span class="n">HAS_QT</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;PyQt5 not found. Install with: pip install PyQt5&quot;</span><span class="p">)</span>


<div class="viewcode-block" id="LoomfieldSimulator3DRealtime">
<a class="viewcode-back" href="../../../api/_autosummary/visualizations.interactive.loomfield_3d_realtime.LoomfieldSimulator3DRealtime.html#visualizations.interactive.loomfield_3d_realtime.LoomfieldSimulator3DRealtime">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">LoomfieldSimulator3DRealtime</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Optimized 3D Loomfield simulator for real-time rendering.</span>

<span class="sd">    Uses smaller grid and efficient numpy operations for smooth performance.</span>
<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="LoomfieldSimulator3DRealtime.__init__">
<a class="viewcode-back" href="../../../api/_autosummary/visualizations.interactive.loomfield_3d_realtime.LoomfieldSimulator3DRealtime.html#visualizations.interactive.loomfield_3d_realtime.LoomfieldSimulator3DRealtime.__init__">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                 <span class="n">grid_size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">32</span><span class="p">,</span>
                 <span class="n">domain_size</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">10.0</span><span class="p">,</span>
                 <span class="n">v_L</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1.0</span><span class="p">,</span>
                 <span class="n">kappa_L</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">2.0</span><span class="p">,</span>
                 <span class="n">damping</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.002</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initialize the real-time 3D simulator.</span>

<span class="sd">        Args:</span>
<span class="sd">            grid_size: Grid points per dimension (32-48 for real-time)</span>
<span class="sd">            domain_size: Physical size of cubic domain</span>
<span class="sd">            v_L: Loomfield propagation speed</span>
<span class="sd">            kappa_L: Coupling constant</span>
<span class="sd">            damping: Dissipation rate</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">N</span> <span class="o">=</span> <span class="n">grid_size</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">L_domain</span> <span class="o">=</span> <span class="n">domain_size</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dx</span> <span class="o">=</span> <span class="n">domain_size</span> <span class="o">/</span> <span class="n">grid_size</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">v_L</span> <span class="o">=</span> <span class="n">v_L</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">kappa_L</span> <span class="o">=</span> <span class="n">kappa_L</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">damping</span> <span class="o">=</span> <span class="n">damping</span>

        <span class="c1"># CFL condition for 3D stability</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dt</span> <span class="o">=</span> <span class="mf">0.4</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">dx</span> <span class="o">/</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">v_L</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">3</span><span class="p">))</span>

        <span class="c1"># Field arrays (float32 for GPU-friendly rendering)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">L</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">N</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">N</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">N</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">L_prev</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">N</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">N</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">N</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rho_coh</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">N</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">N</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">N</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>

        <span class="c1"># Sources</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sources</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">dict</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c1"># Coordinate grids</span>
        <span class="n">coords</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">-</span><span class="n">domain_size</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="n">domain_size</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">N</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">X</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Y</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Z</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span><span class="n">coords</span><span class="p">,</span> <span class="n">coords</span><span class="p">,</span> <span class="n">coords</span><span class="p">,</span> <span class="n">indexing</span><span class="o">=</span><span class="s1">&#39;ij&#39;</span><span class="p">)</span>

        <span class="c1"># Time tracking</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">time</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">step_count</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="c1"># Precompute for efficiency</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_dx2_inv</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dx</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span></div>


    <span class="k">def</span><span class="w"> </span><span class="nf">_laplacian</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">field</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;7-point stencil 3D Laplacian.&quot;&quot;&quot;</span>
        <span class="n">lap</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">field</span><span class="p">)</span>
        <span class="n">lap</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">field</span><span class="p">[</span><span class="mi">2</span><span class="p">:,</span> <span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">field</span><span class="p">[:</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span>
            <span class="n">field</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">:,</span> <span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">field</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">:</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span>
            <span class="n">field</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">:]</span> <span class="o">+</span> <span class="n">field</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">:</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span> <span class="o">-</span>
            <span class="mi">6</span> <span class="o">*</span> <span class="n">field</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dx2_inv</span>
        <span class="k">return</span> <span class="n">lap</span>

<div class="viewcode-block" id="LoomfieldSimulator3DRealtime.add_source">
<a class="viewcode-back" href="../../../api/_autosummary/visualizations.interactive.loomfield_3d_realtime.LoomfieldSimulator3DRealtime.html#visualizations.interactive.loomfield_3d_realtime.LoomfieldSimulator3DRealtime.add_source">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">add_source</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">z</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
                   <span class="n">strength</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1.0</span><span class="p">,</span>
                   <span class="n">radius</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.5</span><span class="p">,</span>
                   <span class="n">frequency</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1.5</span><span class="p">,</span>
                   <span class="n">phase</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">,</span>
                   <span class="n">source_type</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;oscillating&#39;</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Add a coherence source.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sources</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
            <span class="s1">&#39;x&#39;</span><span class="p">:</span> <span class="n">x</span><span class="p">,</span> <span class="s1">&#39;y&#39;</span><span class="p">:</span> <span class="n">y</span><span class="p">,</span> <span class="s1">&#39;z&#39;</span><span class="p">:</span> <span class="n">z</span><span class="p">,</span>
            <span class="s1">&#39;strength&#39;</span><span class="p">:</span> <span class="n">strength</span><span class="p">,</span>
            <span class="s1">&#39;radius&#39;</span><span class="p">:</span> <span class="n">radius</span><span class="p">,</span>
            <span class="s1">&#39;frequency&#39;</span><span class="p">:</span> <span class="n">frequency</span><span class="p">,</span>
            <span class="s1">&#39;phase&#39;</span><span class="p">:</span> <span class="n">phase</span><span class="p">,</span>
            <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="n">source_type</span><span class="p">,</span>
            <span class="s1">&#39;birth_time&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">time</span>
        <span class="p">})</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[DEBUG] Added source at (</span><span class="si">{</span><span class="n">x</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">y</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">z</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">), strength=</span><span class="si">{</span><span class="n">strength</span><span class="si">}</span><span class="s2">, freq=</span><span class="si">{</span><span class="n">frequency</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="LoomfieldSimulator3DRealtime.clear_sources">
<a class="viewcode-back" href="../../../api/_autosummary/visualizations.interactive.loomfield_3d_realtime.LoomfieldSimulator3DRealtime.html#visualizations.interactive.loomfield_3d_realtime.LoomfieldSimulator3DRealtime.clear_sources">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">clear_sources</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Remove all sources.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sources</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rho_coh</span><span class="o">.</span><span class="n">fill</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span></div>


<div class="viewcode-block" id="LoomfieldSimulator3DRealtime.add_perturbation">
<a class="viewcode-back" href="../../../api/_autosummary/visualizations.interactive.loomfield_3d_realtime.LoomfieldSimulator3DRealtime.html#visualizations.interactive.loomfield_3d_realtime.LoomfieldSimulator3DRealtime.add_perturbation">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">add_perturbation</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">z</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
                         <span class="n">strength</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">2.0</span><span class="p">,</span> <span class="n">radius</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1.5</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Add a perturbation that disrupts coherence.&quot;&quot;&quot;</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[DEBUG] Adding perturbation at (</span><span class="si">{</span><span class="n">x</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">y</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">z</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">), strength=</span><span class="si">{</span><span class="n">strength</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">dist_sq</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">X</span> <span class="o">-</span> <span class="n">x</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Y</span> <span class="o">-</span> <span class="n">y</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Z</span> <span class="o">-</span> <span class="n">z</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span>
        <span class="n">envelope</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">dist_sq</span> <span class="o">/</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">radius</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span>

        <span class="n">noise</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">N</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">N</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">N</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
        <span class="n">noise</span> <span class="o">=</span> <span class="n">gaussian_filter</span><span class="p">(</span><span class="n">noise</span><span class="p">,</span> <span class="n">sigma</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>

        <span class="n">velocity_noise</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">N</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">N</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">N</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
        <span class="n">velocity_noise</span> <span class="o">=</span> <span class="n">gaussian_filter</span><span class="p">(</span><span class="n">velocity_noise</span><span class="p">,</span> <span class="n">sigma</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">L</span> <span class="o">+=</span> <span class="n">strength</span> <span class="o">*</span> <span class="n">envelope</span> <span class="o">*</span> <span class="n">noise</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">L_prev</span> <span class="o">+=</span> <span class="n">strength</span> <span class="o">*</span> <span class="mf">0.7</span> <span class="o">*</span> <span class="n">envelope</span> <span class="o">*</span> <span class="n">velocity_noise</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[DEBUG] After perturbation: L range [</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">L</span><span class="o">.</span><span class="n">min</span><span class="p">()</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">L</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">]&quot;</span><span class="p">)</span></div>


    <span class="k">def</span><span class="w"> </span><span class="nf">_update_coherence_density</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Update coherence density from all sources.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rho_coh</span><span class="o">.</span><span class="n">fill</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">src</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">sources</span><span class="p">:</span>
            <span class="n">dist_sq</span> <span class="o">=</span> <span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">X</span> <span class="o">-</span> <span class="n">src</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">])</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span>
                       <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Y</span> <span class="o">-</span> <span class="n">src</span><span class="p">[</span><span class="s1">&#39;y&#39;</span><span class="p">])</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span>
                       <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Z</span> <span class="o">-</span> <span class="n">src</span><span class="p">[</span><span class="s1">&#39;z&#39;</span><span class="p">])</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
            <span class="n">spatial</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">dist_sq</span> <span class="o">/</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">src</span><span class="p">[</span><span class="s1">&#39;radius&#39;</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span>

            <span class="k">if</span> <span class="n">src</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;oscillating&#39;</span><span class="p">:</span>
                <span class="n">temporal</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">src</span><span class="p">[</span><span class="s1">&#39;frequency&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">time</span> <span class="o">+</span> <span class="n">src</span><span class="p">[</span><span class="s1">&#39;phase&#39;</span><span class="p">])</span>
                <span class="n">amplitude</span> <span class="o">=</span> <span class="n">src</span><span class="p">[</span><span class="s1">&#39;strength&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="n">temporal</span>
            <span class="k">elif</span> <span class="n">src</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;pulse&#39;</span><span class="p">:</span>
                <span class="n">dt_birth</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">time</span> <span class="o">-</span> <span class="n">src</span><span class="p">[</span><span class="s1">&#39;birth_time&#39;</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">dt_birth</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">temporal</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="mi">4</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">dt_birth</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">dt_birth</span> <span class="o">/</span> <span class="mf">0.3</span><span class="p">)</span>
                    <span class="n">amplitude</span> <span class="o">=</span> <span class="n">src</span><span class="p">[</span><span class="s1">&#39;strength&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="n">temporal</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">amplitude</span> <span class="o">=</span> <span class="mf">0.0</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">amplitude</span> <span class="o">=</span> <span class="n">src</span><span class="p">[</span><span class="s1">&#39;strength&#39;</span><span class="p">]</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">rho_coh</span> <span class="o">+=</span> <span class="n">amplitude</span> <span class="o">*</span> <span class="n">spatial</span>

<div class="viewcode-block" id="LoomfieldSimulator3DRealtime.step">
<a class="viewcode-back" href="../../../api/_autosummary/visualizations.interactive.loomfield_3d_realtime.LoomfieldSimulator3DRealtime.html#visualizations.interactive.loomfield_3d_realtime.LoomfieldSimulator3DRealtime.step">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">step</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">n_steps</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Advance simulation by n_steps.&quot;&quot;&quot;</span>
        <span class="n">c2dt2</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">v_L</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">dt</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span>
        <span class="n">c_ratio</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">v_L</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">dt</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">dx</span>

        <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_steps</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_update_coherence_density</span><span class="p">()</span>

            <span class="n">lap_L</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_laplacian</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">L</span><span class="p">)</span>
            <span class="n">L_new</span> <span class="o">=</span> <span class="p">(</span>
                <span class="mi">2</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">L</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">L_prev</span> <span class="o">+</span>
                <span class="n">c2dt2</span> <span class="o">*</span> <span class="n">lap_L</span> <span class="o">+</span>
                <span class="n">c2dt2</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">kappa_L</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">rho_coh</span> <span class="o">-</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">damping</span> <span class="o">*</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">L</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">L_prev</span><span class="p">)</span>
            <span class="p">)</span>

            <span class="c1"># Absorbing boundaries (Mur&#39;s method on all 6 faces)</span>
            <span class="n">abc</span> <span class="o">=</span> <span class="p">(</span><span class="n">c_ratio</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">c_ratio</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>

            <span class="n">L_new</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">L</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span> <span class="o">+</span> <span class="n">abc</span> <span class="o">*</span> <span class="p">(</span><span class="n">L_new</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">L</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:])</span>
            <span class="n">L_new</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">L</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span> <span class="o">+</span> <span class="n">abc</span> <span class="o">*</span> <span class="p">(</span><span class="n">L_new</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">L</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:])</span>
            <span class="n">L_new</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">L</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">,</span> <span class="p">:]</span> <span class="o">+</span> <span class="n">abc</span> <span class="o">*</span> <span class="p">(</span><span class="n">L_new</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">,</span> <span class="p">:]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">L</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">:])</span>
            <span class="n">L_new</span><span class="p">[:,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">L</span><span class="p">[:,</span> <span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="p">:]</span> <span class="o">+</span> <span class="n">abc</span> <span class="o">*</span> <span class="p">(</span><span class="n">L_new</span><span class="p">[:,</span> <span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="p">:]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">L</span><span class="p">[:,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">:])</span>
            <span class="n">L_new</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">L</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">abc</span> <span class="o">*</span> <span class="p">(</span><span class="n">L_new</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">L</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">0</span><span class="p">])</span>
            <span class="n">L_new</span><span class="p">[:,</span> <span class="p">:,</span> <span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">L</span><span class="p">[:,</span> <span class="p">:,</span> <span class="o">-</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="n">abc</span> <span class="o">*</span> <span class="p">(</span><span class="n">L_new</span><span class="p">[:,</span> <span class="p">:,</span> <span class="o">-</span><span class="mi">2</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">L</span><span class="p">[:,</span> <span class="p">:,</span> <span class="o">-</span><span class="mi">1</span><span class="p">])</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">L_prev</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">L</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">L</span> <span class="o">=</span> <span class="n">L_new</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">time</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dt</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">step_count</span> <span class="o">+=</span> <span class="mi">1</span></div>


<div class="viewcode-block" id="LoomfieldSimulator3DRealtime.get_total_coherence">
<a class="viewcode-back" href="../../../api/_autosummary/visualizations.interactive.loomfield_3d_realtime.LoomfieldSimulator3DRealtime.html#visualizations.interactive.loomfield_3d_realtime.LoomfieldSimulator3DRealtime.get_total_coherence">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_total_coherence</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Calculate Q metric.&quot;&quot;&quot;</span>
        <span class="n">total_energy</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">L</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">total_energy</span> <span class="o">&lt;</span> <span class="mf">1e-10</span><span class="p">:</span>
            <span class="k">return</span> <span class="mf">0.0</span>

        <span class="n">grad_x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">L</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">append</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">L</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">:,</span> <span class="p">:,</span> <span class="p">:])</span>
        <span class="n">grad_y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">L</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">append</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">L</span><span class="p">[:,</span> <span class="o">-</span><span class="mi">1</span><span class="p">:,</span> <span class="p">:])</span>
        <span class="n">grad_z</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">L</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">append</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">L</span><span class="p">[:,</span> <span class="p">:,</span> <span class="o">-</span><span class="mi">1</span><span class="p">:])</span>
        <span class="n">roughness</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">grad_x</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">grad_y</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">grad_z</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>

        <span class="n">L_shifted_x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">roll</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">L</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">L_shifted_y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">roll</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">L</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">L_shifted_z</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">roll</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">L</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>

        <span class="n">corr_x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">L</span> <span class="o">*</span> <span class="n">L_shifted_x</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">total_energy</span> <span class="o">+</span> <span class="mf">1e-10</span><span class="p">)</span>
        <span class="n">corr_y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">L</span> <span class="o">*</span> <span class="n">L_shifted_y</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">total_energy</span> <span class="o">+</span> <span class="mf">1e-10</span><span class="p">)</span>
        <span class="n">corr_z</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">L</span> <span class="o">*</span> <span class="n">L_shifted_z</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">total_energy</span> <span class="o">+</span> <span class="mf">1e-10</span><span class="p">)</span>
        <span class="n">correlation</span> <span class="o">=</span> <span class="p">(</span><span class="n">corr_x</span> <span class="o">+</span> <span class="n">corr_y</span> <span class="o">+</span> <span class="n">corr_z</span><span class="p">)</span> <span class="o">/</span> <span class="mf">3.0</span>

        <span class="n">Q</span> <span class="o">=</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">+</span> <span class="n">correlation</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">+</span> <span class="mf">0.001</span> <span class="o">*</span> <span class="n">roughness</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">max</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">Q</span><span class="p">)</span></div>


<div class="viewcode-block" id="LoomfieldSimulator3DRealtime.get_consciousness_metric">
<a class="viewcode-back" href="../../../api/_autosummary/visualizations.interactive.loomfield_3d_realtime.LoomfieldSimulator3DRealtime.html#visualizations.interactive.loomfield_3d_realtime.LoomfieldSimulator3DRealtime.get_consciousness_metric">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_consciousness_metric</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Calculate C_bio = Q³ × activity.&quot;&quot;&quot;</span>
        <span class="n">Q</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_total_coherence</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">Q</span> <span class="o">&lt;</span> <span class="mf">0.01</span><span class="p">:</span>
            <span class="k">return</span> <span class="mf">0.0</span>

        <span class="n">dL_dt</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">L</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">L_prev</span><span class="p">)</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">dt</span>
        <span class="n">temporal_activity</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">dL_dt</span><span class="p">)</span>
        <span class="n">local_coupling</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rho_coh</span><span class="p">)</span> <span class="o">*</span> <span class="n">temporal_activity</span>
        <span class="n">raw_activity</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">local_coupling</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dx</span> <span class="o">**</span> <span class="mi">3</span><span class="p">)</span>

        <span class="k">return</span> <span class="p">(</span><span class="n">Q</span> <span class="o">**</span> <span class="mi">3</span><span class="p">)</span> <span class="o">*</span> <span class="n">raw_activity</span></div>


<div class="viewcode-block" id="LoomfieldSimulator3DRealtime.get_field_energy">
<a class="viewcode-back" href="../../../api/_autosummary/visualizations.interactive.loomfield_3d_realtime.LoomfieldSimulator3DRealtime.html#visualizations.interactive.loomfield_3d_realtime.LoomfieldSimulator3DRealtime.get_field_energy">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_field_energy</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Total field energy.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">L</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dx</span> <span class="o">**</span> <span class="mi">3</span><span class="p">)</span></div>


<div class="viewcode-block" id="LoomfieldSimulator3DRealtime.reset">
<a class="viewcode-back" href="../../../api/_autosummary/visualizations.interactive.loomfield_3d_realtime.LoomfieldSimulator3DRealtime.html#visualizations.interactive.loomfield_3d_realtime.LoomfieldSimulator3DRealtime.reset">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">reset</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Reset simulation.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">L</span><span class="o">.</span><span class="n">fill</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">L_prev</span><span class="o">.</span><span class="n">fill</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rho_coh</span><span class="o">.</span><span class="n">fill</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sources</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">time</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">step_count</span> <span class="o">=</span> <span class="mi">0</span></div>


<div class="viewcode-block" id="LoomfieldSimulator3DRealtime.get_slice">
<a class="viewcode-back" href="../../../api/_autosummary/visualizations.interactive.loomfield_3d_realtime.LoomfieldSimulator3DRealtime.html#visualizations.interactive.loomfield_3d_realtime.LoomfieldSimulator3DRealtime.get_slice">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_slice</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">axis</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;z&#39;</span><span class="p">,</span> <span class="n">index</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get 2D slice through the field.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">index</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">index</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">N</span> <span class="o">//</span> <span class="mi">2</span>
        <span class="n">index</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">min</span><span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">N</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span>

        <span class="k">if</span> <span class="n">axis</span> <span class="o">==</span> <span class="s1">&#39;x&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">L</span><span class="p">[</span><span class="n">index</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span>
        <span class="k">elif</span> <span class="n">axis</span> <span class="o">==</span> <span class="s1">&#39;y&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">L</span><span class="p">[:,</span> <span class="n">index</span><span class="p">,</span> <span class="p">:]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">L</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">index</span><span class="p">]</span></div>
</div>



<span class="c1"># =============================================================================</span>
<span class="c1"># PRESET CONFIGURATIONS</span>
<span class="c1"># =============================================================================</span>

<span class="k">def</span><span class="w"> </span><span class="nf">create_healthy_preset</span><span class="p">(</span><span class="n">sim</span><span class="p">:</span> <span class="n">LoomfieldSimulator3DRealtime</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Healthy: Phase-locked sources.&quot;&quot;&quot;</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;[DEBUG] Loading HEALTHY preset...&quot;</span><span class="p">)</span>
    <span class="n">sim</span><span class="o">.</span><span class="n">reset</span><span class="p">()</span>
    <span class="n">base_freq</span> <span class="o">=</span> <span class="mf">1.2</span>

    <span class="n">sim</span><span class="o">.</span><span class="n">add_source</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">strength</span><span class="o">=</span><span class="mf">1.5</span><span class="p">,</span> <span class="n">radius</span><span class="o">=</span><span class="mf">0.6</span><span class="p">,</span> <span class="n">frequency</span><span class="o">=</span><span class="n">base_freq</span><span class="p">,</span> <span class="n">phase</span><span class="o">=</span><span class="mf">0.0</span><span class="p">)</span>

    <span class="n">r</span> <span class="o">=</span> <span class="mf">2.5</span>
    <span class="k">for</span> <span class="n">pos</span> <span class="ow">in</span> <span class="p">[(</span><span class="n">r</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">),</span> <span class="p">(</span><span class="o">-</span><span class="n">r</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">),</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">r</span><span class="p">,</span><span class="mi">0</span><span class="p">),</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="o">-</span><span class="n">r</span><span class="p">,</span><span class="mi">0</span><span class="p">),</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">r</span><span class="p">),</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="o">-</span><span class="n">r</span><span class="p">)]:</span>
        <span class="n">sim</span><span class="o">.</span><span class="n">add_source</span><span class="p">(</span><span class="o">*</span><span class="n">pos</span><span class="p">,</span> <span class="n">strength</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span> <span class="n">radius</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">frequency</span><span class="o">=</span><span class="n">base_freq</span><span class="p">,</span> <span class="n">phase</span><span class="o">=</span><span class="mf">0.0</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[DEBUG] Healthy preset loaded: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">sim</span><span class="o">.</span><span class="n">sources</span><span class="p">)</span><span class="si">}</span><span class="s2"> sources&quot;</span><span class="p">)</span>


<span class="k">def</span><span class="w"> </span><span class="nf">create_pathology_preset</span><span class="p">(</span><span class="n">sim</span><span class="p">:</span> <span class="n">LoomfieldSimulator3DRealtime</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Pathology: Incoherent sources with different frequencies.&quot;&quot;&quot;</span>
    <span class="n">sim</span><span class="o">.</span><span class="n">reset</span><span class="p">()</span>

    <span class="n">positions</span> <span class="o">=</span> <span class="p">[(</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="p">(</span><span class="mf">2.5</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mf">1.5</span><span class="p">),</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="o">-</span><span class="mi">2</span><span class="p">),</span>
                 <span class="p">(</span><span class="mf">1.5</span><span class="p">,</span> <span class="mf">1.5</span><span class="p">,</span> <span class="o">-</span><span class="mf">1.5</span><span class="p">),</span> <span class="p">(</span><span class="o">-</span><span class="mf">2.5</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mf">2.5</span><span class="p">,</span> <span class="o">-</span><span class="mi">2</span><span class="p">)]</span>
    <span class="n">frequencies</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.7</span><span class="p">,</span> <span class="mf">1.9</span><span class="p">,</span> <span class="mf">2.3</span><span class="p">,</span> <span class="mf">1.1</span><span class="p">,</span> <span class="mf">2.8</span><span class="p">,</span> <span class="mf">0.9</span><span class="p">]</span>
    <span class="n">phases</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">1.2</span><span class="p">,</span> <span class="mf">2.5</span><span class="p">,</span> <span class="mf">0.8</span><span class="p">,</span> <span class="mf">3.1</span><span class="p">,</span> <span class="mf">1.9</span><span class="p">]</span>

    <span class="k">for</span> <span class="n">pos</span><span class="p">,</span> <span class="n">freq</span><span class="p">,</span> <span class="n">phase</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">positions</span><span class="p">,</span> <span class="n">frequencies</span><span class="p">,</span> <span class="n">phases</span><span class="p">):</span>
        <span class="n">sim</span><span class="o">.</span><span class="n">add_source</span><span class="p">(</span><span class="o">*</span><span class="n">pos</span><span class="p">,</span> <span class="n">strength</span><span class="o">=</span><span class="mf">0.7</span><span class="p">,</span> <span class="n">radius</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">frequency</span><span class="o">=</span><span class="n">freq</span><span class="p">,</span> <span class="n">phase</span><span class="o">=</span><span class="n">phase</span><span class="p">)</span>


<span class="k">def</span><span class="w"> </span><span class="nf">create_healing_preset</span><span class="p">(</span><span class="n">sim</span><span class="p">:</span> <span class="n">LoomfieldSimulator3DRealtime</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Healing: Re-coupling toward coherence.&quot;&quot;&quot;</span>
    <span class="n">sim</span><span class="o">.</span><span class="n">reset</span><span class="p">()</span>
    <span class="n">base_freq</span> <span class="o">=</span> <span class="mf">1.0</span>

    <span class="n">sim</span><span class="o">.</span><span class="n">add_source</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">strength</span><span class="o">=</span><span class="mf">1.8</span><span class="p">,</span> <span class="n">radius</span><span class="o">=</span><span class="mf">0.7</span><span class="p">,</span> <span class="n">frequency</span><span class="o">=</span><span class="n">base_freq</span><span class="p">,</span> <span class="n">phase</span><span class="o">=</span><span class="mf">0.0</span><span class="p">)</span>

    <span class="n">r</span> <span class="o">=</span> <span class="mf">3.0</span>
    <span class="n">n_ring</span> <span class="o">=</span> <span class="mi">8</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_ring</span><span class="p">):</span>
        <span class="n">angle</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">i</span> <span class="o">/</span> <span class="n">n_ring</span>
        <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">r</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">angle</span><span class="p">),</span> <span class="n">r</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">angle</span><span class="p">)</span>
        <span class="n">phase</span> <span class="o">=</span> <span class="n">angle</span> <span class="o">*</span> <span class="mf">0.5</span>
        <span class="n">sim</span><span class="o">.</span><span class="n">add_source</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">strength</span><span class="o">=</span><span class="mf">0.6</span><span class="p">,</span> <span class="n">radius</span><span class="o">=</span><span class="mf">0.4</span><span class="p">,</span> <span class="n">frequency</span><span class="o">=</span><span class="n">base_freq</span><span class="p">,</span> <span class="n">phase</span><span class="o">=</span><span class="n">phase</span><span class="p">)</span>


<span class="c1"># =============================================================================</span>
<span class="c1"># VISPY 3D VISUALIZER</span>
<span class="c1"># =============================================================================</span>

<span class="k">if</span> <span class="n">HAS_VISPY</span> <span class="ow">and</span> <span class="n">HAS_QT</span><span class="p">:</span>

    <span class="k">class</span><span class="w"> </span><span class="nc">Loomfield3DVisualizer</span><span class="p">(</span><span class="n">QtWidgets</span><span class="o">.</span><span class="n">QMainWindow</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Real-time interactive 3D Loomfield visualizer.</span>

<span class="sd">        Uses vispy for fast 3D rendering and Qt for controls.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">grid_size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">32</span><span class="p">):</span>
            <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">sim</span> <span class="o">=</span> <span class="n">LoomfieldSimulator3DRealtime</span><span class="p">(</span><span class="n">grid_size</span><span class="o">=</span><span class="n">grid_size</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">grid_size</span> <span class="o">=</span> <span class="n">grid_size</span>

            <span class="c1"># Animation state</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">running</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">steps_per_frame</span> <span class="o">=</span> <span class="mi">3</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">mode</span> <span class="o">=</span> <span class="s1">&#39;add_source&#39;</span>  <span class="c1"># &#39;add_source&#39; or &#39;perturbation&#39;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">slice_index</span> <span class="o">=</span> <span class="n">grid_size</span> <span class="o">//</span> <span class="mi">2</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">show_slice</span> <span class="o">=</span> <span class="kc">False</span>

            <span class="c1"># Render mode: &#39;slices&#39; or &#39;isosurface&#39;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">render_mode</span> <span class="o">=</span> <span class="s1">&#39;slices&#39;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">render_modes</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;slices&#39;</span><span class="p">,</span> <span class="s1">&#39;isosurface&#39;</span><span class="p">]</span>

            <span class="c1"># Visual references (set in _create_* methods)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">slice_xy</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">slice_xz</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">slice_yz</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">isosurfaces</span> <span class="o">=</span> <span class="p">[]</span>

            <span class="c1"># Create colormap: blue -&gt; dark -&gt; gold</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cmap</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_colormap</span><span class="p">()</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">_setup_ui</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_setup_timer</span><span class="p">()</span>

            <span class="c1"># Start with healthy preset and warm up</span>
            <span class="n">create_healthy_preset</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">step</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span>  <span class="c1"># Warm up so field is immediately visible</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">_create_colormap</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot;Create bipolar colormap for Loomfield with high visibility.&quot;&quot;&quot;</span>
            <span class="c1"># For MIP rendering, we need colors that show up well</span>
            <span class="c1"># Strong colors at extremes, visible color at center</span>
            <span class="n">colors</span> <span class="o">=</span> <span class="p">[</span>
                <span class="p">(</span><span class="mf">0.2</span><span class="p">,</span> <span class="mf">0.4</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">),</span>    <span class="c1"># Strong blue (negative/low)</span>
                <span class="p">(</span><span class="mf">0.4</span><span class="p">,</span> <span class="mf">0.6</span><span class="p">,</span> <span class="mf">0.9</span><span class="p">,</span> <span class="mf">0.6</span><span class="p">),</span>    <span class="c1"># Medium blue</span>
                <span class="p">(</span><span class="mf">0.3</span><span class="p">,</span> <span class="mf">0.3</span><span class="p">,</span> <span class="mf">0.4</span><span class="p">,</span> <span class="mf">0.3</span><span class="p">),</span>    <span class="c1"># Dim gray (center) - still visible</span>
                <span class="p">(</span><span class="mf">0.9</span><span class="p">,</span> <span class="mf">0.7</span><span class="p">,</span> <span class="mf">0.3</span><span class="p">,</span> <span class="mf">0.6</span><span class="p">),</span>    <span class="c1"># Medium gold</span>
                <span class="p">(</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">0.85</span><span class="p">,</span> <span class="mf">0.3</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">),</span>   <span class="c1"># Strong gold (positive/high)</span>
            <span class="p">]</span>
            <span class="k">return</span> <span class="n">color</span><span class="o">.</span><span class="n">Colormap</span><span class="p">(</span><span class="n">colors</span><span class="p">,</span> <span class="n">controls</span><span class="o">=</span><span class="p">[</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.25</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.75</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">])</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">_setup_ui</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot;Set up the main window UI.&quot;&quot;&quot;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">setWindowTitle</span><span class="p">(</span><span class="s1">&#39;Loomfield 3D - Real-Time Simulator&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">setGeometry</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="mi">1400</span><span class="p">,</span> <span class="mi">900</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">setStyleSheet</span><span class="p">(</span><span class="s2">&quot;background-color: #0a0a14;&quot;</span><span class="p">)</span>

            <span class="c1"># Central widget</span>
            <span class="n">central</span> <span class="o">=</span> <span class="n">QtWidgets</span><span class="o">.</span><span class="n">QWidget</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">setCentralWidget</span><span class="p">(</span><span class="n">central</span><span class="p">)</span>

            <span class="c1"># Main layout</span>
            <span class="n">layout</span> <span class="o">=</span> <span class="n">QtWidgets</span><span class="o">.</span><span class="n">QHBoxLayout</span><span class="p">(</span><span class="n">central</span><span class="p">)</span>
            <span class="n">layout</span><span class="o">.</span><span class="n">setContentsMargins</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>

            <span class="c1"># 3D canvas (left side)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">canvas</span> <span class="o">=</span> <span class="n">scene</span><span class="o">.</span><span class="n">SceneCanvas</span><span class="p">(</span>
                <span class="n">keys</span><span class="o">=</span><span class="s1">&#39;interactive&#39;</span><span class="p">,</span>
                <span class="n">bgcolor</span><span class="o">=</span><span class="s1">&#39;#0a0a14&#39;</span><span class="p">,</span>
                <span class="n">show</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">size</span><span class="o">=</span><span class="p">(</span><span class="mi">900</span><span class="p">,</span> <span class="mi">800</span><span class="p">)</span>
            <span class="p">)</span>
            <span class="n">layout</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">native</span><span class="p">,</span> <span class="n">stretch</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>

            <span class="c1"># Create 3D view</span>
            <span class="c1"># Camera distance should be ~1.5x the grid size to see the full volume</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">view</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">central_widget</span><span class="o">.</span><span class="n">add_view</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">view</span><span class="o">.</span><span class="n">camera</span> <span class="o">=</span> <span class="n">scene</span><span class="o">.</span><span class="n">cameras</span><span class="o">.</span><span class="n">TurntableCamera</span><span class="p">(</span>
                <span class="n">fov</span><span class="o">=</span><span class="mi">45</span><span class="p">,</span>
                <span class="n">distance</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">grid_size</span> <span class="o">*</span> <span class="mf">1.5</span><span class="p">,</span>  <span class="c1"># Scale with grid size</span>
                <span class="n">elevation</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span>
                <span class="n">azimuth</span><span class="o">=</span><span class="mi">45</span>
            <span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[DEBUG] Camera distance set to </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">grid_size</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mf">1.5</span><span class="si">}</span><span class="s2"> for grid_size=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">grid_size</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="c1"># Volume visual</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_create_volume_visual</span><span class="p">()</span>

            <span class="c1"># Slice visual (initially hidden)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_create_slice_visual</span><span class="p">()</span>

            <span class="c1"># Control panel (right side)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_setup_controls</span><span class="p">(</span><span class="n">layout</span><span class="p">)</span>

            <span class="c1"># Connect canvas events</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">events</span><span class="o">.</span><span class="n">mouse_press</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_on_mouse_press</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">events</span><span class="o">.</span><span class="n">mouse_release</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_on_mouse_release</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">events</span><span class="o">.</span><span class="n">key_press</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_on_key_press</span><span class="p">)</span>

            <span class="c1"># Track mouse press position for click vs drag detection</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_mouse_press_pos</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_click_threshold</span> <span class="o">=</span> <span class="mi">5</span>  <span class="c1"># pixels - movement below this is a &quot;click&quot;</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">_create_volume_visual</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot;Create all 3D visualization modes.</span>

<span class="sd">            Supports two render modes:</span>
<span class="sd">            - &#39;slices&#39;: 3 orthogonal Image slices (most compatible)</span>
<span class="sd">            - &#39;isosurface&#39;: Nested transparent isosurface shells</span>
<span class="sd">            &quot;&quot;&quot;</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[DEBUG] Creating 3D visualization modes&quot;</span><span class="p">)</span>

            <span class="c1"># Create visual types</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_create_slice_visuals</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_create_isosurface_visuals</span><span class="p">()</span>

            <span class="c1"># Add a wireframe cube to show boundaries</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_create_boundary_box</span><span class="p">()</span>

            <span class="c1"># Add source markers</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_create_source_markers</span><span class="p">()</span>

            <span class="c1"># Set initial visibility based on render_mode</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_set_render_mode</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">render_mode</span><span class="p">)</span>

            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[DEBUG] Render modes created. Current mode: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">render_mode</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">_create_slice_visuals</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot;Create the 3 orthogonal slice plane visuals.&quot;&quot;&quot;</span>
            <span class="n">N</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">grid_size</span>
            <span class="n">center</span> <span class="o">=</span> <span class="n">N</span> <span class="o">//</span> <span class="mi">2</span>

            <span class="c1"># Prepare slice data</span>
            <span class="n">xy_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_prepare_slice_for_axis</span><span class="p">(</span><span class="s1">&#39;z&#39;</span><span class="p">,</span> <span class="n">center</span><span class="p">)</span>
            <span class="n">xz_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_prepare_slice_for_axis</span><span class="p">(</span><span class="s1">&#39;y&#39;</span><span class="p">,</span> <span class="n">center</span><span class="p">)</span>
            <span class="n">yz_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_prepare_slice_for_axis</span><span class="p">(</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="n">center</span><span class="p">)</span>

            <span class="c1"># XY plane (horizontal slice at z=center)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">slice_xy</span> <span class="o">=</span> <span class="n">scene</span><span class="o">.</span><span class="n">visuals</span><span class="o">.</span><span class="n">Image</span><span class="p">(</span>
                <span class="n">xy_data</span><span class="p">,</span>
                <span class="n">parent</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">view</span><span class="o">.</span><span class="n">scene</span><span class="p">,</span>
                <span class="n">cmap</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">cmap</span><span class="p">,</span>
                <span class="n">clim</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">slice_xy</span><span class="o">.</span><span class="n">transform</span> <span class="o">=</span> <span class="n">STTransform</span><span class="p">(</span>
                <span class="n">translate</span><span class="o">=</span><span class="p">(</span><span class="o">-</span><span class="n">N</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="o">-</span><span class="n">N</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
                <span class="n">scale</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
            <span class="p">)</span>

            <span class="c1"># XZ plane (vertical slice at y=center)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">slice_xz</span> <span class="o">=</span> <span class="n">scene</span><span class="o">.</span><span class="n">visuals</span><span class="o">.</span><span class="n">Image</span><span class="p">(</span>
                <span class="n">xz_data</span><span class="p">,</span>
                <span class="n">parent</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">view</span><span class="o">.</span><span class="n">scene</span><span class="p">,</span>
                <span class="n">cmap</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">cmap</span><span class="p">,</span>
                <span class="n">clim</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
            <span class="p">)</span>
            <span class="n">xz_transform</span> <span class="o">=</span> <span class="n">MatrixTransform</span><span class="p">()</span>
            <span class="n">xz_transform</span><span class="o">.</span><span class="n">rotate</span><span class="p">(</span><span class="mi">90</span><span class="p">,</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
            <span class="n">xz_transform</span><span class="o">.</span><span class="n">translate</span><span class="p">((</span><span class="o">-</span><span class="n">N</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="n">N</span><span class="o">/</span><span class="mi">2</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">slice_xz</span><span class="o">.</span><span class="n">transform</span> <span class="o">=</span> <span class="n">xz_transform</span>

            <span class="c1"># YZ plane (vertical slice at x=center)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">slice_yz</span> <span class="o">=</span> <span class="n">scene</span><span class="o">.</span><span class="n">visuals</span><span class="o">.</span><span class="n">Image</span><span class="p">(</span>
                <span class="n">yz_data</span><span class="p">,</span>
                <span class="n">parent</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">view</span><span class="o">.</span><span class="n">scene</span><span class="p">,</span>
                <span class="n">cmap</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">cmap</span><span class="p">,</span>
                <span class="n">clim</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
            <span class="p">)</span>
            <span class="n">yz_transform</span> <span class="o">=</span> <span class="n">MatrixTransform</span><span class="p">()</span>
            <span class="n">yz_transform</span><span class="o">.</span><span class="n">rotate</span><span class="p">(</span><span class="mi">90</span><span class="p">,</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
            <span class="n">yz_transform</span><span class="o">.</span><span class="n">rotate</span><span class="p">(</span><span class="mi">90</span><span class="p">,</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
            <span class="n">yz_transform</span><span class="o">.</span><span class="n">translate</span><span class="p">((</span><span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="n">N</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="o">-</span><span class="n">N</span><span class="o">/</span><span class="mi">2</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">slice_yz</span><span class="o">.</span><span class="n">transform</span> <span class="o">=</span> <span class="n">yz_transform</span>

            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[DEBUG] Created slice visuals at center=</span><span class="si">{</span><span class="n">center</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">_create_isosurface_visuals</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot;Create nested isosurface shells as an alternative to Volume.</span>

<span class="sd">            Creates multiple transparent Isosurface visuals at different</span>
<span class="sd">            threshold levels. This often works when Volume rendering fails.</span>
<span class="sd">            &quot;&quot;&quot;</span>
            <span class="c1"># Isosurfaces are created dynamically in _update_isosurfaces()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">isosurfaces</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[DEBUG] Isosurface mode initialized (surfaces created on update)&quot;</span><span class="p">)</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">_update_isosurfaces</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot;Update or recreate isosurface visuals based on current field.</span>

<span class="sd">            vispy&#39;s Isosurface generates mesh vertices in data index coordinates.</span>
<span class="sd">            For a (N, N, N) array, vertices span [0, N-1] in each dimension.</span>
<span class="sd">            We transform to match slice coordinates: [-N/2, N/2].</span>
<span class="sd">            &quot;&quot;&quot;</span>
            <span class="c1"># Remove old isosurfaces</span>
            <span class="k">for</span> <span class="n">iso</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">isosurfaces</span><span class="p">:</span>
                <span class="n">iso</span><span class="o">.</span><span class="n">parent</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">isosurfaces</span> <span class="o">=</span> <span class="p">[]</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="n">L</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">L</span>
                <span class="n">N</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">grid_size</span>
                <span class="n">L_absmax</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">L</span><span class="p">)</span><span class="o">.</span><span class="n">max</span><span class="p">(),</span> <span class="mf">0.1</span><span class="p">)</span>

                <span class="c1"># Debug first time</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;_iso_debug_done&#39;</span><span class="p">):</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[DEBUG] Isosurface: L.shape=</span><span class="si">{</span><span class="n">L</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">, N=</span><span class="si">{</span><span class="n">N</span><span class="si">}</span><span class="s2">, L_absmax=</span><span class="si">{</span><span class="n">L_absmax</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_iso_debug_done</span> <span class="o">=</span> <span class="kc">True</span>

                <span class="c1"># Threshold levels (as fractions of max)</span>
                <span class="n">thresholds</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.3</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.7</span><span class="p">]</span>  <span class="c1"># Slightly higher thresholds for visibility</span>
                <span class="n">colors_pos</span> <span class="o">=</span> <span class="p">[</span>
                    <span class="p">(</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">0.9</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.3</span><span class="p">),</span>   <span class="c1"># Light gold</span>
                    <span class="p">(</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">0.8</span><span class="p">,</span> <span class="mf">0.3</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">),</span>   <span class="c1"># Gold</span>
                    <span class="p">(</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">0.7</span><span class="p">,</span> <span class="mf">0.2</span><span class="p">,</span> <span class="mf">0.7</span><span class="p">),</span>   <span class="c1"># Deep gold</span>
                <span class="p">]</span>
                <span class="n">colors_neg</span> <span class="o">=</span> <span class="p">[</span>
                    <span class="p">(</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.7</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="mf">0.3</span><span class="p">),</span>   <span class="c1"># Light blue</span>
                    <span class="p">(</span><span class="mf">0.3</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">),</span>   <span class="c1"># Blue</span>
                    <span class="p">(</span><span class="mf">0.2</span><span class="p">,</span> <span class="mf">0.4</span><span class="p">,</span> <span class="mf">0.9</span><span class="p">,</span> <span class="mf">0.7</span><span class="p">),</span>   <span class="c1"># Deep blue</span>
                <span class="p">]</span>

                <span class="c1"># Transform: data indices [0, N-1] -&gt; visual coords [-N/2, N/2-1]</span>
                <span class="c1"># vispy Isosurface vertices are in data index space</span>
                <span class="n">iso_transform</span> <span class="o">=</span> <span class="n">STTransform</span><span class="p">(</span>
                    <span class="n">translate</span><span class="o">=</span><span class="p">(</span><span class="o">-</span><span class="n">N</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="o">-</span><span class="n">N</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="o">-</span><span class="n">N</span><span class="o">/</span><span class="mi">2</span><span class="p">),</span>
                    <span class="n">scale</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
                <span class="p">)</span>

                <span class="k">for</span> <span class="n">thresh_frac</span><span class="p">,</span> <span class="n">color_p</span><span class="p">,</span> <span class="n">color_n</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">thresholds</span><span class="p">,</span> <span class="n">colors_pos</span><span class="p">,</span> <span class="n">colors_neg</span><span class="p">):</span>
                    <span class="n">thresh_val</span> <span class="o">=</span> <span class="n">thresh_frac</span> <span class="o">*</span> <span class="n">L_absmax</span>

                    <span class="c1"># Positive isosurface (gold)</span>
                    <span class="k">if</span> <span class="n">L</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="o">&gt;</span> <span class="n">thresh_val</span><span class="p">:</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">iso_pos</span> <span class="o">=</span> <span class="n">scene</span><span class="o">.</span><span class="n">visuals</span><span class="o">.</span><span class="n">Isosurface</span><span class="p">(</span>
                                <span class="n">L</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="n">thresh_val</span><span class="p">,</span>
                                <span class="n">color</span><span class="o">=</span><span class="n">color_p</span><span class="p">,</span>
                                <span class="n">parent</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">view</span><span class="o">.</span><span class="n">scene</span><span class="p">,</span>
                            <span class="p">)</span>
                            <span class="n">iso_pos</span><span class="o">.</span><span class="n">transform</span> <span class="o">=</span> <span class="n">iso_transform</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">isosurfaces</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">iso_pos</span><span class="p">)</span>
                        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                            <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;_iso_pos_error&#39;</span><span class="p">):</span>
                                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[DEBUG] Isosurface+ error: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">_iso_pos_error</span> <span class="o">=</span> <span class="kc">True</span>

                    <span class="c1"># Negative isosurface (blue)</span>
                    <span class="k">if</span> <span class="n">L</span><span class="o">.</span><span class="n">min</span><span class="p">()</span> <span class="o">&lt;</span> <span class="o">-</span><span class="n">thresh_val</span><span class="p">:</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">iso_neg</span> <span class="o">=</span> <span class="n">scene</span><span class="o">.</span><span class="n">visuals</span><span class="o">.</span><span class="n">Isosurface</span><span class="p">(</span>
                                <span class="o">-</span><span class="n">L</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="n">thresh_val</span><span class="p">,</span>
                                <span class="n">color</span><span class="o">=</span><span class="n">color_n</span><span class="p">,</span>
                                <span class="n">parent</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">view</span><span class="o">.</span><span class="n">scene</span><span class="p">,</span>
                            <span class="p">)</span>
                            <span class="n">iso_neg</span><span class="o">.</span><span class="n">transform</span> <span class="o">=</span> <span class="n">iso_transform</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">isosurfaces</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">iso_neg</span><span class="p">)</span>
                        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                            <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;_iso_neg_error&#39;</span><span class="p">):</span>
                                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[DEBUG] Isosurface- error: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">_iso_neg_error</span> <span class="o">=</span> <span class="kc">True</span>

            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[DEBUG] Isosurface update error: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">_set_render_mode</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mode</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot;Set the active render mode and update visibility.&quot;&quot;&quot;</span>
            <span class="k">if</span> <span class="n">mode</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">render_modes</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[DEBUG] Unknown render mode: </span><span class="si">{</span><span class="n">mode</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">return</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">render_mode</span> <span class="o">=</span> <span class="n">mode</span>
            <span class="n">N</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">grid_size</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[DEBUG] Switching to render mode: </span><span class="si">{</span><span class="n">mode</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="c1"># Reset camera to default distance when switching modes</span>
            <span class="c1"># This ensures all modes are viewable at the same scale</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">view</span><span class="o">.</span><span class="n">camera</span><span class="o">.</span><span class="n">distance</span> <span class="o">=</span> <span class="n">N</span> <span class="o">*</span> <span class="mf">1.5</span>

            <span class="c1"># Hide all visuals first</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">slice_xy</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">slice_xy</span><span class="o">.</span><span class="n">visible</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">slice_xz</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">slice_xz</span><span class="o">.</span><span class="n">visible</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">slice_yz</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">slice_yz</span><span class="o">.</span><span class="n">visible</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">for</span> <span class="n">iso</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">isosurfaces</span><span class="p">:</span>
                <span class="n">iso</span><span class="o">.</span><span class="n">visible</span> <span class="o">=</span> <span class="kc">False</span>

            <span class="c1"># Show visuals for current mode</span>
            <span class="k">if</span> <span class="n">mode</span> <span class="o">==</span> <span class="s1">&#39;slices&#39;</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">slice_xy</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">slice_xy</span><span class="o">.</span><span class="n">visible</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">slice_xz</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">slice_xz</span><span class="o">.</span><span class="n">visible</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">slice_yz</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">slice_yz</span><span class="o">.</span><span class="n">visible</span> <span class="o">=</span> <span class="kc">True</span>

            <span class="k">elif</span> <span class="n">mode</span> <span class="o">==</span> <span class="s1">&#39;isosurface&#39;</span><span class="p">:</span>
                <span class="c1"># Isosurfaces are recreated each frame, just update them now</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_update_isosurfaces</span><span class="p">()</span>
                <span class="k">for</span> <span class="n">iso</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">isosurfaces</span><span class="p">:</span>
                    <span class="n">iso</span><span class="o">.</span><span class="n">visible</span> <span class="o">=</span> <span class="kc">True</span>

            <span class="c1"># Update the mode label if it exists</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;mode_label&#39;</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">mode_label</span><span class="o">.</span><span class="n">setText</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Render: </span><span class="si">{</span><span class="n">mode</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">_cycle_render_mode</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot;Cycle to the next render mode (slices &lt;-&gt; isosurface).&quot;&quot;&quot;</span>
            <span class="n">current_idx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">render_modes</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">render_mode</span><span class="p">)</span>
            <span class="n">next_idx</span> <span class="o">=</span> <span class="p">(</span><span class="n">current_idx</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">render_modes</span><span class="p">)</span>
            <span class="n">next_mode</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">render_modes</span><span class="p">[</span><span class="n">next_idx</span><span class="p">]</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[DEBUG] Cycling: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">render_mode</span><span class="si">}</span><span class="s2"> -&gt; </span><span class="si">{</span><span class="n">next_mode</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_set_render_mode</span><span class="p">(</span><span class="n">next_mode</span><span class="p">)</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">_create_boundary_box</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot;Create a wireframe box showing the volume boundaries.&quot;&quot;&quot;</span>
            <span class="n">N</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">grid_size</span>
            <span class="c1"># 8 corners of the cube</span>
            <span class="n">vertices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span>
                <span class="p">[</span><span class="o">-</span><span class="n">N</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="o">-</span><span class="n">N</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="o">-</span><span class="n">N</span><span class="o">/</span><span class="mi">2</span><span class="p">],</span> <span class="p">[</span><span class="n">N</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="o">-</span><span class="n">N</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="o">-</span><span class="n">N</span><span class="o">/</span><span class="mi">2</span><span class="p">],</span>
                <span class="p">[</span><span class="n">N</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="n">N</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="o">-</span><span class="n">N</span><span class="o">/</span><span class="mi">2</span><span class="p">],</span> <span class="p">[</span><span class="o">-</span><span class="n">N</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="n">N</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="o">-</span><span class="n">N</span><span class="o">/</span><span class="mi">2</span><span class="p">],</span>
                <span class="p">[</span><span class="o">-</span><span class="n">N</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="o">-</span><span class="n">N</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="n">N</span><span class="o">/</span><span class="mi">2</span><span class="p">],</span> <span class="p">[</span><span class="n">N</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="o">-</span><span class="n">N</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="n">N</span><span class="o">/</span><span class="mi">2</span><span class="p">],</span>
                <span class="p">[</span><span class="n">N</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="n">N</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="n">N</span><span class="o">/</span><span class="mi">2</span><span class="p">],</span> <span class="p">[</span><span class="o">-</span><span class="n">N</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="n">N</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="n">N</span><span class="o">/</span><span class="mi">2</span><span class="p">],</span>
            <span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>

            <span class="c1"># 12 edges of the cube</span>
            <span class="n">edges</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span>
                <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span> <span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">],</span> <span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>  <span class="c1"># Bottom face</span>
                <span class="p">[</span><span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">],</span> <span class="p">[</span><span class="mi">5</span><span class="p">,</span> <span class="mi">6</span><span class="p">],</span> <span class="p">[</span><span class="mi">6</span><span class="p">,</span> <span class="mi">7</span><span class="p">],</span> <span class="p">[</span><span class="mi">7</span><span class="p">,</span> <span class="mi">4</span><span class="p">],</span>  <span class="c1"># Top face</span>
                <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">4</span><span class="p">],</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">5</span><span class="p">],</span> <span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">6</span><span class="p">],</span> <span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="mi">7</span><span class="p">],</span>  <span class="c1"># Vertical edges</span>
            <span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">uint32</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">boundary_box</span> <span class="o">=</span> <span class="n">scene</span><span class="o">.</span><span class="n">visuals</span><span class="o">.</span><span class="n">Line</span><span class="p">(</span>
                <span class="n">pos</span><span class="o">=</span><span class="n">vertices</span><span class="p">,</span>
                <span class="n">connect</span><span class="o">=</span><span class="n">edges</span><span class="p">,</span>
                <span class="n">color</span><span class="o">=</span><span class="p">(</span><span class="mf">0.3</span><span class="p">,</span> <span class="mf">0.4</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">),</span>
                <span class="n">parent</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">view</span><span class="o">.</span><span class="n">scene</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">_create_source_markers</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot;Create visual markers for source positions.&quot;&quot;&quot;</span>
            <span class="c1"># Create markers visual (spheres at source locations)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">source_markers</span> <span class="o">=</span> <span class="n">scene</span><span class="o">.</span><span class="n">visuals</span><span class="o">.</span><span class="n">Markers</span><span class="p">(</span>
                <span class="n">parent</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">view</span><span class="o">.</span><span class="n">scene</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_update_source_markers</span><span class="p">()</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">_get_source_positions</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot;Get array of source positions for visualization.&quot;&quot;&quot;</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">sources</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>  <span class="c1"># Dummy point</span>

            <span class="n">positions</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">src</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">sources</span><span class="p">:</span>
                <span class="c1"># Convert from physical coords to grid coords for display</span>
                <span class="c1"># Physical domain is [-L/2, L/2], display is [-N/2, N/2]</span>
                <span class="n">scale</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">grid_size</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">L_domain</span>
                <span class="n">x</span> <span class="o">=</span> <span class="n">src</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="n">scale</span>
                <span class="n">y</span> <span class="o">=</span> <span class="n">src</span><span class="p">[</span><span class="s1">&#39;y&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="n">scale</span>
                <span class="n">z</span> <span class="o">=</span> <span class="n">src</span><span class="p">[</span><span class="s1">&#39;z&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="n">scale</span>
                <span class="n">positions</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span><span class="p">])</span>

            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">positions</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">_update_source_markers</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot;Update source marker positions and appearance.&quot;&quot;&quot;</span>
            <span class="n">positions</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_source_positions</span><span class="p">()</span>

            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">sources</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="c1"># Hide markers if no sources</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">source_markers</span><span class="o">.</span><span class="n">set_data</span><span class="p">(</span>
                    <span class="n">pos</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">)),</span>
                    <span class="n">face_color</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
                    <span class="n">size</span><span class="o">=</span><span class="mi">0</span>
                <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># Show white markers with gold edge</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">source_markers</span><span class="o">.</span><span class="n">set_data</span><span class="p">(</span>
                    <span class="n">pos</span><span class="o">=</span><span class="n">positions</span><span class="p">,</span>
                    <span class="n">face_color</span><span class="o">=</span><span class="p">(</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="mf">0.9</span><span class="p">),</span>
                    <span class="n">edge_color</span><span class="o">=</span><span class="p">(</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">0.8</span><span class="p">,</span> <span class="mf">0.3</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">),</span>
                    <span class="n">edge_width</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
                    <span class="n">size</span><span class="o">=</span><span class="mi">12</span><span class="p">,</span>
                    <span class="n">symbol</span><span class="o">=</span><span class="s1">&#39;o&#39;</span>
                <span class="p">)</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">_prepare_slice_for_axis</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">axis</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">index</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot;Prepare a 2D slice with enhanced contrast for the given axis.</span>

<span class="sd">            vispy Image expects data[row, col] = data[y, x], so we transpose</span>
<span class="sd">            the physics data L[x, y, z] to match the visual coordinate system.</span>
<span class="sd">            &quot;&quot;&quot;</span>
            <span class="k">if</span> <span class="n">axis</span> <span class="o">==</span> <span class="s1">&#39;x&#39;</span><span class="p">:</span>
                <span class="c1"># YZ plane: L[x_index, y, z] -&gt; want [z, y] for Image (row=z, col=y)</span>
                <span class="n">slice_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">L</span><span class="p">[</span><span class="n">index</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span><span class="o">.</span><span class="n">T</span>
            <span class="k">elif</span> <span class="n">axis</span> <span class="o">==</span> <span class="s1">&#39;y&#39;</span><span class="p">:</span>
                <span class="c1"># XZ plane: L[x, y_index, z] -&gt; want [z, x] for Image (row=z, col=x)</span>
                <span class="n">slice_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">L</span><span class="p">[:,</span> <span class="n">index</span><span class="p">,</span> <span class="p">:]</span><span class="o">.</span><span class="n">T</span>
            <span class="k">else</span><span class="p">:</span>  <span class="c1"># z</span>
                <span class="c1"># XY plane: L[x, y, z_index] -&gt; want [y, x] for Image (row=y, col=x)</span>
                <span class="n">slice_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">L</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">index</span><span class="p">]</span><span class="o">.</span><span class="n">T</span>

            <span class="n">L_absmax</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">slice_data</span><span class="p">)</span><span class="o">.</span><span class="n">max</span><span class="p">(),</span> <span class="mf">0.05</span><span class="p">)</span>
            <span class="n">slice_norm</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">slice_data</span> <span class="o">/</span> <span class="n">L_absmax</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
            <span class="n">slice_enhanced</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sign</span><span class="p">(</span><span class="n">slice_norm</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">slice_norm</span><span class="p">))</span>
            <span class="k">return</span> <span class="p">((</span><span class="n">slice_enhanced</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">_create_slice_visual</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot;Create the 2D slice plane visualization.&quot;&quot;&quot;</span>
            <span class="n">slice_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_prepare_slice_data</span><span class="p">()</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">slice_image</span> <span class="o">=</span> <span class="n">scene</span><span class="o">.</span><span class="n">visuals</span><span class="o">.</span><span class="n">Image</span><span class="p">(</span>
                <span class="n">slice_data</span><span class="p">,</span>
                <span class="n">parent</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">view</span><span class="o">.</span><span class="n">scene</span><span class="p">,</span>
                <span class="n">cmap</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">cmap</span><span class="p">,</span>
                <span class="n">clim</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>  <span class="c1"># Match the 0-1 range of our normalized data</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">slice_image</span><span class="o">.</span><span class="n">transform</span> <span class="o">=</span> <span class="n">STTransform</span><span class="p">(</span>
                <span class="n">translate</span><span class="o">=</span><span class="p">(</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">grid_size</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">grid_size</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">slice_index</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">grid_size</span><span class="o">/</span><span class="mi">2</span><span class="p">),</span>
                <span class="n">scale</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">slice_image</span><span class="o">.</span><span class="n">visible</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">show_slice</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">_prepare_slice_data</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot;Prepare 2D slice data with same normalization as volume.&quot;&quot;&quot;</span>
            <span class="n">slice_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">get_slice</span><span class="p">(</span><span class="s1">&#39;z&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">slice_index</span><span class="p">)</span>
            <span class="n">L_absmax</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">slice_data</span><span class="p">)</span><span class="o">.</span><span class="n">max</span><span class="p">(),</span> <span class="mf">0.05</span><span class="p">)</span>
            <span class="n">slice_norm</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">slice_data</span> <span class="o">/</span> <span class="n">L_absmax</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
            <span class="n">slice_enhanced</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sign</span><span class="p">(</span><span class="n">slice_norm</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">slice_norm</span><span class="p">))</span>
            <span class="k">return</span> <span class="p">((</span><span class="n">slice_enhanced</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">_prepare_volume_data</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot;Prepare volume data for rendering (kept for potential future use).&quot;&quot;&quot;</span>
            <span class="n">L</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">L</span>
            <span class="n">L_absmax</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">L</span><span class="p">)</span><span class="o">.</span><span class="n">max</span><span class="p">(),</span> <span class="mf">0.05</span><span class="p">)</span>
            <span class="n">L_norm</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">L</span> <span class="o">/</span> <span class="n">L_absmax</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
            <span class="n">L_enhanced</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sign</span><span class="p">(</span><span class="n">L_norm</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">L_norm</span><span class="p">))</span>
            <span class="n">volume_data</span> <span class="o">=</span> <span class="p">((</span><span class="n">L_enhanced</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">volume_data</span><span class="p">,</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">_setup_controls</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">parent_layout</span><span class="p">):</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot;Set up the control panel.&quot;&quot;&quot;</span>
            <span class="n">control_panel</span> <span class="o">=</span> <span class="n">QtWidgets</span><span class="o">.</span><span class="n">QWidget</span><span class="p">()</span>
            <span class="n">control_panel</span><span class="o">.</span><span class="n">setFixedWidth</span><span class="p">(</span><span class="mi">350</span><span class="p">)</span>
            <span class="n">control_panel</span><span class="o">.</span><span class="n">setStyleSheet</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">                QWidget { color: #b0b0b0; }</span>
<span class="s2">                QLabel { font-size: 11px; }</span>
<span class="s2">                QPushButton {</span>
<span class="s2">                    background-color: #252540;</span>
<span class="s2">                    border: 1px solid #404060;</span>
<span class="s2">                    border-radius: 4px;</span>
<span class="s2">                    padding: 8px;</span>
<span class="s2">                    color: #b0b0b0;</span>
<span class="s2">                    font-weight: bold;</span>
<span class="s2">                }</span>
<span class="s2">                QPushButton:hover { background-color: #353560; }</span>
<span class="s2">                QPushButton:pressed { background-color: #454580; }</span>
<span class="s2">                QPushButton:checked { background-color: #406080; border-color: #60a0ff; }</span>
<span class="s2">                QSlider::groove:horizontal {</span>
<span class="s2">                    background: #252540;</span>
<span class="s2">                    height: 8px;</span>
<span class="s2">                    border-radius: 4px;</span>
<span class="s2">                }</span>
<span class="s2">                QSlider::handle:horizontal {</span>
<span class="s2">                    background: #6080a0;</span>
<span class="s2">                    width: 16px;</span>
<span class="s2">                    margin: -4px 0;</span>
<span class="s2">                    border-radius: 8px;</span>
<span class="s2">                }</span>
<span class="s2">                QGroupBox {</span>
<span class="s2">                    border: 1px solid #404060;</span>
<span class="s2">                    border-radius: 4px;</span>
<span class="s2">                    margin-top: 10px;</span>
<span class="s2">                    padding-top: 10px;</span>
<span class="s2">                }</span>
<span class="s2">                QGroupBox::title {</span>
<span class="s2">                    color: #80a0c0;</span>
<span class="s2">                    subcontrol-origin: margin;</span>
<span class="s2">                    left: 10px;</span>
<span class="s2">                    padding: 0 5px;</span>
<span class="s2">                }</span>
<span class="s2">            &quot;&quot;&quot;</span><span class="p">)</span>

            <span class="n">controls_layout</span> <span class="o">=</span> <span class="n">QtWidgets</span><span class="o">.</span><span class="n">QVBoxLayout</span><span class="p">(</span><span class="n">control_panel</span><span class="p">)</span>
            <span class="n">controls_layout</span><span class="o">.</span><span class="n">setSpacing</span><span class="p">(</span><span class="mi">15</span><span class="p">)</span>

            <span class="c1"># Title</span>
            <span class="n">title</span> <span class="o">=</span> <span class="n">QtWidgets</span><span class="o">.</span><span class="n">QLabel</span><span class="p">(</span><span class="s2">&quot;COSMIC LOOM THEORY&quot;</span><span class="p">)</span>
            <span class="n">title</span><span class="o">.</span><span class="n">setStyleSheet</span><span class="p">(</span><span class="s2">&quot;font-size: 16px; font-weight: bold; color: #80a0c0;&quot;</span><span class="p">)</span>
            <span class="n">title</span><span class="o">.</span><span class="n">setAlignment</span><span class="p">(</span><span class="n">QtCore</span><span class="o">.</span><span class="n">Qt</span><span class="o">.</span><span class="n">AlignCenter</span><span class="p">)</span>
            <span class="n">controls_layout</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="n">title</span><span class="p">)</span>

            <span class="n">subtitle</span> <span class="o">=</span> <span class="n">QtWidgets</span><span class="o">.</span><span class="n">QLabel</span><span class="p">(</span><span class="s2">&quot;3D Loomfield Simulator&quot;</span><span class="p">)</span>
            <span class="n">subtitle</span><span class="o">.</span><span class="n">setStyleSheet</span><span class="p">(</span><span class="s2">&quot;font-size: 12px; color: #606080;&quot;</span><span class="p">)</span>
            <span class="n">subtitle</span><span class="o">.</span><span class="n">setAlignment</span><span class="p">(</span><span class="n">QtCore</span><span class="o">.</span><span class="n">Qt</span><span class="o">.</span><span class="n">AlignCenter</span><span class="p">)</span>
            <span class="n">controls_layout</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="n">subtitle</span><span class="p">)</span>

            <span class="n">controls_layout</span><span class="o">.</span><span class="n">addSpacing</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>

            <span class="c1"># Metrics display</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_setup_metrics</span><span class="p">(</span><span class="n">controls_layout</span><span class="p">)</span>

            <span class="c1"># Preset buttons</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_setup_presets</span><span class="p">(</span><span class="n">controls_layout</span><span class="p">)</span>

            <span class="c1"># Mode buttons</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_setup_modes</span><span class="p">(</span><span class="n">controls_layout</span><span class="p">)</span>

            <span class="c1"># Sliders</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_setup_sliders</span><span class="p">(</span><span class="n">controls_layout</span><span class="p">)</span>

            <span class="c1"># Slice controls</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_setup_slice_controls</span><span class="p">(</span><span class="n">controls_layout</span><span class="p">)</span>

            <span class="c1"># Control buttons</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_setup_buttons</span><span class="p">(</span><span class="n">controls_layout</span><span class="p">)</span>

            <span class="n">controls_layout</span><span class="o">.</span><span class="n">addStretch</span><span class="p">()</span>

            <span class="c1"># Instructions</span>
            <span class="n">instructions</span> <span class="o">=</span> <span class="n">QtWidgets</span><span class="o">.</span><span class="n">QLabel</span><span class="p">(</span>
                <span class="s2">&quot;CONTROLS:</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="s2">&quot;• Click to add source/perturbation</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="s2">&quot;• Drag to rotate view</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="s2">&quot;• Scroll to zoom</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="s2">&quot;• &#39;V&#39; = toggle Slices/Isosurface</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="s2">&quot;• &#39;R&#39; = reset camera</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="s2">&quot;• &#39;S&#39; = random source</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="s2">&quot;• &#39;P&#39; = random perturbation&quot;</span>
            <span class="p">)</span>
            <span class="n">instructions</span><span class="o">.</span><span class="n">setStyleSheet</span><span class="p">(</span><span class="s2">&quot;font-size: 10px; color: #606080; padding: 10px;&quot;</span><span class="p">)</span>
            <span class="n">controls_layout</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="n">instructions</span><span class="p">)</span>

            <span class="n">parent_layout</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="n">control_panel</span><span class="p">)</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">_setup_metrics</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">layout</span><span class="p">):</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot;Set up metrics display.&quot;&quot;&quot;</span>
            <span class="n">metrics_group</span> <span class="o">=</span> <span class="n">QtWidgets</span><span class="o">.</span><span class="n">QGroupBox</span><span class="p">(</span><span class="s2">&quot;METRICS&quot;</span><span class="p">)</span>
            <span class="n">metrics_layout</span> <span class="o">=</span> <span class="n">QtWidgets</span><span class="o">.</span><span class="n">QGridLayout</span><span class="p">(</span><span class="n">metrics_group</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">q_label</span> <span class="o">=</span> <span class="n">QtWidgets</span><span class="o">.</span><span class="n">QLabel</span><span class="p">(</span><span class="s2">&quot;Q: --&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">q_label</span><span class="o">.</span><span class="n">setStyleSheet</span><span class="p">(</span><span class="s2">&quot;font-size: 14px; color: #80ffaa;&quot;</span><span class="p">)</span>
            <span class="n">metrics_layout</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="n">QtWidgets</span><span class="o">.</span><span class="n">QLabel</span><span class="p">(</span><span class="s2">&quot;Coherence:&quot;</span><span class="p">),</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
            <span class="n">metrics_layout</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">q_label</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">cbio_label</span> <span class="o">=</span> <span class="n">QtWidgets</span><span class="o">.</span><span class="n">QLabel</span><span class="p">(</span><span class="s2">&quot;C_bio: --&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cbio_label</span><span class="o">.</span><span class="n">setStyleSheet</span><span class="p">(</span><span class="s2">&quot;font-size: 14px; color: #ffaa80;&quot;</span><span class="p">)</span>
            <span class="n">metrics_layout</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="n">QtWidgets</span><span class="o">.</span><span class="n">QLabel</span><span class="p">(</span><span class="s2">&quot;Consciousness:&quot;</span><span class="p">),</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
            <span class="n">metrics_layout</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cbio_label</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">time_label</span> <span class="o">=</span> <span class="n">QtWidgets</span><span class="o">.</span><span class="n">QLabel</span><span class="p">(</span><span class="s2">&quot;t: 0.0&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">time_label</span><span class="o">.</span><span class="n">setStyleSheet</span><span class="p">(</span><span class="s2">&quot;font-size: 12px; color: #8080a0;&quot;</span><span class="p">)</span>
            <span class="n">metrics_layout</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="n">QtWidgets</span><span class="o">.</span><span class="n">QLabel</span><span class="p">(</span><span class="s2">&quot;Time:&quot;</span><span class="p">),</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
            <span class="n">metrics_layout</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">time_label</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">sources_label</span> <span class="o">=</span> <span class="n">QtWidgets</span><span class="o">.</span><span class="n">QLabel</span><span class="p">(</span><span class="s2">&quot;Sources: 0&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sources_label</span><span class="o">.</span><span class="n">setStyleSheet</span><span class="p">(</span><span class="s2">&quot;font-size: 12px; color: #8080a0;&quot;</span><span class="p">)</span>
            <span class="n">metrics_layout</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="n">QtWidgets</span><span class="o">.</span><span class="n">QLabel</span><span class="p">(</span><span class="s2">&quot;Active:&quot;</span><span class="p">),</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
            <span class="n">metrics_layout</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sources_label</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

            <span class="c1"># Render mode indicator</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">mode_label</span> <span class="o">=</span> <span class="n">QtWidgets</span><span class="o">.</span><span class="n">QLabel</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Render: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">render_mode</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">mode_label</span><span class="o">.</span><span class="n">setStyleSheet</span><span class="p">(</span><span class="s2">&quot;font-size: 12px; color: #a080ff; font-weight: bold;&quot;</span><span class="p">)</span>
            <span class="n">metrics_layout</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="n">QtWidgets</span><span class="o">.</span><span class="n">QLabel</span><span class="p">(</span><span class="s2">&quot;Mode:&quot;</span><span class="p">),</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
            <span class="n">metrics_layout</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mode_label</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

            <span class="n">layout</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="n">metrics_group</span><span class="p">)</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">_setup_presets</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">layout</span><span class="p">):</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot;Set up preset buttons.&quot;&quot;&quot;</span>
            <span class="n">presets_group</span> <span class="o">=</span> <span class="n">QtWidgets</span><span class="o">.</span><span class="n">QGroupBox</span><span class="p">(</span><span class="s2">&quot;PRESETS&quot;</span><span class="p">)</span>
            <span class="n">presets_layout</span> <span class="o">=</span> <span class="n">QtWidgets</span><span class="o">.</span><span class="n">QHBoxLayout</span><span class="p">(</span><span class="n">presets_group</span><span class="p">)</span>

            <span class="n">btn_healthy</span> <span class="o">=</span> <span class="n">QtWidgets</span><span class="o">.</span><span class="n">QPushButton</span><span class="p">(</span><span class="s2">&quot;Healthy&quot;</span><span class="p">)</span>
            <span class="n">btn_healthy</span><span class="o">.</span><span class="n">clicked</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_load_preset</span><span class="p">(</span><span class="s1">&#39;healthy&#39;</span><span class="p">))</span>
            <span class="n">btn_healthy</span><span class="o">.</span><span class="n">setStyleSheet</span><span class="p">(</span><span class="s2">&quot;QPushButton { background-color: #204020; }&quot;</span><span class="p">)</span>
            <span class="n">presets_layout</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="n">btn_healthy</span><span class="p">)</span>

            <span class="n">btn_pathology</span> <span class="o">=</span> <span class="n">QtWidgets</span><span class="o">.</span><span class="n">QPushButton</span><span class="p">(</span><span class="s2">&quot;Pathology&quot;</span><span class="p">)</span>
            <span class="n">btn_pathology</span><span class="o">.</span><span class="n">clicked</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_load_preset</span><span class="p">(</span><span class="s1">&#39;pathology&#39;</span><span class="p">))</span>
            <span class="n">btn_pathology</span><span class="o">.</span><span class="n">setStyleSheet</span><span class="p">(</span><span class="s2">&quot;QPushButton { background-color: #402020; }&quot;</span><span class="p">)</span>
            <span class="n">presets_layout</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="n">btn_pathology</span><span class="p">)</span>

            <span class="n">btn_healing</span> <span class="o">=</span> <span class="n">QtWidgets</span><span class="o">.</span><span class="n">QPushButton</span><span class="p">(</span><span class="s2">&quot;Healing&quot;</span><span class="p">)</span>
            <span class="n">btn_healing</span><span class="o">.</span><span class="n">clicked</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_load_preset</span><span class="p">(</span><span class="s1">&#39;healing&#39;</span><span class="p">))</span>
            <span class="n">btn_healing</span><span class="o">.</span><span class="n">setStyleSheet</span><span class="p">(</span><span class="s2">&quot;QPushButton { background-color: #203040; }&quot;</span><span class="p">)</span>
            <span class="n">presets_layout</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="n">btn_healing</span><span class="p">)</span>

            <span class="n">layout</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="n">presets_group</span><span class="p">)</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">_setup_modes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">layout</span><span class="p">):</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot;Set up interaction mode buttons.&quot;&quot;&quot;</span>
            <span class="n">modes_group</span> <span class="o">=</span> <span class="n">QtWidgets</span><span class="o">.</span><span class="n">QGroupBox</span><span class="p">(</span><span class="s2">&quot;CLICK MODE&quot;</span><span class="p">)</span>
            <span class="n">modes_layout</span> <span class="o">=</span> <span class="n">QtWidgets</span><span class="o">.</span><span class="n">QHBoxLayout</span><span class="p">(</span><span class="n">modes_group</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">btn_source</span> <span class="o">=</span> <span class="n">QtWidgets</span><span class="o">.</span><span class="n">QPushButton</span><span class="p">(</span><span class="s2">&quot;Add Source&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">btn_source</span><span class="o">.</span><span class="n">setCheckable</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">btn_source</span><span class="o">.</span><span class="n">setChecked</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">btn_source</span><span class="o">.</span><span class="n">clicked</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_set_mode</span><span class="p">(</span><span class="s1">&#39;add_source&#39;</span><span class="p">))</span>
            <span class="n">modes_layout</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">btn_source</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">btn_perturb</span> <span class="o">=</span> <span class="n">QtWidgets</span><span class="o">.</span><span class="n">QPushButton</span><span class="p">(</span><span class="s2">&quot;Perturbation&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">btn_perturb</span><span class="o">.</span><span class="n">setCheckable</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">btn_perturb</span><span class="o">.</span><span class="n">clicked</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_set_mode</span><span class="p">(</span><span class="s1">&#39;perturbation&#39;</span><span class="p">))</span>
            <span class="n">modes_layout</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">btn_perturb</span><span class="p">)</span>

            <span class="n">layout</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="n">modes_group</span><span class="p">)</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">_setup_sliders</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">layout</span><span class="p">):</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot;Set up parameter sliders.&quot;&quot;&quot;</span>
            <span class="n">sliders_group</span> <span class="o">=</span> <span class="n">QtWidgets</span><span class="o">.</span><span class="n">QGroupBox</span><span class="p">(</span><span class="s2">&quot;PARAMETERS&quot;</span><span class="p">)</span>
            <span class="n">sliders_layout</span> <span class="o">=</span> <span class="n">QtWidgets</span><span class="o">.</span><span class="n">QVBoxLayout</span><span class="p">(</span><span class="n">sliders_group</span><span class="p">)</span>

            <span class="c1"># v_L slider</span>
            <span class="n">vl_layout</span> <span class="o">=</span> <span class="n">QtWidgets</span><span class="o">.</span><span class="n">QHBoxLayout</span><span class="p">()</span>
            <span class="n">vl_layout</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="n">QtWidgets</span><span class="o">.</span><span class="n">QLabel</span><span class="p">(</span><span class="s2">&quot;v_L (speed):&quot;</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">vl_slider</span> <span class="o">=</span> <span class="n">QtWidgets</span><span class="o">.</span><span class="n">QSlider</span><span class="p">(</span><span class="n">QtCore</span><span class="o">.</span><span class="n">Qt</span><span class="o">.</span><span class="n">Horizontal</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">vl_slider</span><span class="o">.</span><span class="n">setRange</span><span class="p">(</span><span class="mi">20</span><span class="p">,</span> <span class="mi">300</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">vl_slider</span><span class="o">.</span><span class="n">setValue</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">vl_slider</span><span class="o">.</span><span class="n">valueChanged</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_update_vl</span><span class="p">)</span>
            <span class="n">vl_layout</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">vl_slider</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">vl_value</span> <span class="o">=</span> <span class="n">QtWidgets</span><span class="o">.</span><span class="n">QLabel</span><span class="p">(</span><span class="s2">&quot;1.0&quot;</span><span class="p">)</span>
            <span class="n">vl_layout</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">vl_value</span><span class="p">)</span>
            <span class="n">sliders_layout</span><span class="o">.</span><span class="n">addLayout</span><span class="p">(</span><span class="n">vl_layout</span><span class="p">)</span>

            <span class="c1"># kappa_L slider</span>
            <span class="n">kappa_layout</span> <span class="o">=</span> <span class="n">QtWidgets</span><span class="o">.</span><span class="n">QHBoxLayout</span><span class="p">()</span>
            <span class="n">kappa_layout</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="n">QtWidgets</span><span class="o">.</span><span class="n">QLabel</span><span class="p">(</span><span class="s2">&quot;κ_L (coupling):&quot;</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">kappa_slider</span> <span class="o">=</span> <span class="n">QtWidgets</span><span class="o">.</span><span class="n">QSlider</span><span class="p">(</span><span class="n">QtCore</span><span class="o">.</span><span class="n">Qt</span><span class="o">.</span><span class="n">Horizontal</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">kappa_slider</span><span class="o">.</span><span class="n">setRange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">50</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">kappa_slider</span><span class="o">.</span><span class="n">setValue</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">kappa_slider</span><span class="o">.</span><span class="n">valueChanged</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_update_kappa</span><span class="p">)</span>
            <span class="n">kappa_layout</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">kappa_slider</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">kappa_value</span> <span class="o">=</span> <span class="n">QtWidgets</span><span class="o">.</span><span class="n">QLabel</span><span class="p">(</span><span class="s2">&quot;2.0&quot;</span><span class="p">)</span>
            <span class="n">kappa_layout</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">kappa_value</span><span class="p">)</span>
            <span class="n">sliders_layout</span><span class="o">.</span><span class="n">addLayout</span><span class="p">(</span><span class="n">kappa_layout</span><span class="p">)</span>

            <span class="c1"># Speed slider</span>
            <span class="n">speed_layout</span> <span class="o">=</span> <span class="n">QtWidgets</span><span class="o">.</span><span class="n">QHBoxLayout</span><span class="p">()</span>
            <span class="n">speed_layout</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="n">QtWidgets</span><span class="o">.</span><span class="n">QLabel</span><span class="p">(</span><span class="s2">&quot;Speed:&quot;</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">speed_slider</span> <span class="o">=</span> <span class="n">QtWidgets</span><span class="o">.</span><span class="n">QSlider</span><span class="p">(</span><span class="n">QtCore</span><span class="o">.</span><span class="n">Qt</span><span class="o">.</span><span class="n">Horizontal</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">speed_slider</span><span class="o">.</span><span class="n">setRange</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">speed_slider</span><span class="o">.</span><span class="n">setValue</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">speed_slider</span><span class="o">.</span><span class="n">valueChanged</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_update_speed</span><span class="p">)</span>
            <span class="n">speed_layout</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">speed_slider</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">speed_value</span> <span class="o">=</span> <span class="n">QtWidgets</span><span class="o">.</span><span class="n">QLabel</span><span class="p">(</span><span class="s2">&quot;3&quot;</span><span class="p">)</span>
            <span class="n">speed_layout</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">speed_value</span><span class="p">)</span>
            <span class="n">sliders_layout</span><span class="o">.</span><span class="n">addLayout</span><span class="p">(</span><span class="n">speed_layout</span><span class="p">)</span>

            <span class="n">layout</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="n">sliders_group</span><span class="p">)</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">_setup_slice_controls</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">layout</span><span class="p">):</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot;Set up slice plane controls.&quot;&quot;&quot;</span>
            <span class="n">slice_group</span> <span class="o">=</span> <span class="n">QtWidgets</span><span class="o">.</span><span class="n">QGroupBox</span><span class="p">(</span><span class="s2">&quot;SLICE PLANE&quot;</span><span class="p">)</span>
            <span class="n">slice_layout</span> <span class="o">=</span> <span class="n">QtWidgets</span><span class="o">.</span><span class="n">QVBoxLayout</span><span class="p">(</span><span class="n">slice_group</span><span class="p">)</span>

            <span class="c1"># Toggle slice visibility</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">slice_checkbox</span> <span class="o">=</span> <span class="n">QtWidgets</span><span class="o">.</span><span class="n">QCheckBox</span><span class="p">(</span><span class="s2">&quot;Show Slice&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">slice_checkbox</span><span class="o">.</span><span class="n">stateChanged</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_toggle_slice</span><span class="p">)</span>
            <span class="n">slice_layout</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">slice_checkbox</span><span class="p">)</span>

            <span class="c1"># Slice position slider</span>
            <span class="n">pos_layout</span> <span class="o">=</span> <span class="n">QtWidgets</span><span class="o">.</span><span class="n">QHBoxLayout</span><span class="p">()</span>
            <span class="n">pos_layout</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="n">QtWidgets</span><span class="o">.</span><span class="n">QLabel</span><span class="p">(</span><span class="s2">&quot;Z Position:&quot;</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">slice_slider</span> <span class="o">=</span> <span class="n">QtWidgets</span><span class="o">.</span><span class="n">QSlider</span><span class="p">(</span><span class="n">QtCore</span><span class="o">.</span><span class="n">Qt</span><span class="o">.</span><span class="n">Horizontal</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">slice_slider</span><span class="o">.</span><span class="n">setRange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">grid_size</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">slice_slider</span><span class="o">.</span><span class="n">setValue</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">grid_size</span> <span class="o">//</span> <span class="mi">2</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">slice_slider</span><span class="o">.</span><span class="n">valueChanged</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_update_slice_position</span><span class="p">)</span>
            <span class="n">pos_layout</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">slice_slider</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">slice_pos_label</span> <span class="o">=</span> <span class="n">QtWidgets</span><span class="o">.</span><span class="n">QLabel</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">grid_size</span> <span class="o">//</span> <span class="mi">2</span><span class="p">))</span>
            <span class="n">pos_layout</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">slice_pos_label</span><span class="p">)</span>
            <span class="n">slice_layout</span><span class="o">.</span><span class="n">addLayout</span><span class="p">(</span><span class="n">pos_layout</span><span class="p">)</span>

            <span class="n">layout</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="n">slice_group</span><span class="p">)</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">_setup_buttons</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">layout</span><span class="p">):</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot;Set up control buttons.&quot;&quot;&quot;</span>
            <span class="n">buttons_layout</span> <span class="o">=</span> <span class="n">QtWidgets</span><span class="o">.</span><span class="n">QHBoxLayout</span><span class="p">()</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">btn_play</span> <span class="o">=</span> <span class="n">QtWidgets</span><span class="o">.</span><span class="n">QPushButton</span><span class="p">(</span><span class="s2">&quot;⏸ Pause&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">btn_play</span><span class="o">.</span><span class="n">clicked</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_toggle_play</span><span class="p">)</span>
            <span class="n">buttons_layout</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">btn_play</span><span class="p">)</span>

            <span class="n">btn_clear</span> <span class="o">=</span> <span class="n">QtWidgets</span><span class="o">.</span><span class="n">QPushButton</span><span class="p">(</span><span class="s2">&quot;Clear&quot;</span><span class="p">)</span>
            <span class="n">btn_clear</span><span class="o">.</span><span class="n">clicked</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_clear</span><span class="p">)</span>
            <span class="n">buttons_layout</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="n">btn_clear</span><span class="p">)</span>

            <span class="n">btn_reset</span> <span class="o">=</span> <span class="n">QtWidgets</span><span class="o">.</span><span class="n">QPushButton</span><span class="p">(</span><span class="s2">&quot;Reset&quot;</span><span class="p">)</span>
            <span class="n">btn_reset</span><span class="o">.</span><span class="n">clicked</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_reset</span><span class="p">)</span>
            <span class="n">buttons_layout</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="n">btn_reset</span><span class="p">)</span>

            <span class="n">layout</span><span class="o">.</span><span class="n">addLayout</span><span class="p">(</span><span class="n">buttons_layout</span><span class="p">)</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">_setup_timer</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot;Set up animation timer.&quot;&quot;&quot;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">timer</span> <span class="o">=</span> <span class="n">QtCore</span><span class="o">.</span><span class="n">QTimer</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">timer</span><span class="o">.</span><span class="n">timeout</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_update</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">timer</span><span class="o">.</span><span class="n">start</span><span class="p">(</span><span class="mi">33</span><span class="p">)</span>  <span class="c1"># ~30 FPS</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">_update</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot;Animation update callback.&quot;&quot;&quot;</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">running</span><span class="p">:</span>
                <span class="k">return</span>

            <span class="c1"># Step simulation</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">step</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">steps_per_frame</span><span class="p">)</span>

            <span class="c1"># Update visuals based on current render mode</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">render_mode</span> <span class="o">==</span> <span class="s1">&#39;slices&#39;</span><span class="p">:</span>
                <span class="c1"># Update the 3 orthogonal slice planes</span>
                <span class="n">center</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">grid_size</span> <span class="o">//</span> <span class="mi">2</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">slice_xy</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">slice_xy</span><span class="o">.</span><span class="n">set_data</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_prepare_slice_for_axis</span><span class="p">(</span><span class="s1">&#39;z&#39;</span><span class="p">,</span> <span class="n">center</span><span class="p">))</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">slice_xz</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">slice_xz</span><span class="o">.</span><span class="n">set_data</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_prepare_slice_for_axis</span><span class="p">(</span><span class="s1">&#39;y&#39;</span><span class="p">,</span> <span class="n">center</span><span class="p">))</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">slice_yz</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">slice_yz</span><span class="o">.</span><span class="n">set_data</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_prepare_slice_for_axis</span><span class="p">(</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="n">center</span><span class="p">))</span>

            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">render_mode</span> <span class="o">==</span> <span class="s1">&#39;isosurface&#39;</span><span class="p">:</span>
                <span class="c1"># Recreate isosurfaces (they need to be rebuilt for new data)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_update_isosurfaces</span><span class="p">()</span>

            <span class="c1"># Update source markers (always visible)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_update_source_markers</span><span class="p">()</span>

            <span class="c1"># Debug output every 60 frames (reduced frequency)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;_frame_count&#39;</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_frame_count</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_frame_count</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_frame_count</span> <span class="o">%</span> <span class="mi">60</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">L</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">L</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[DEBUG] Frame </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_frame_count</span><span class="si">}</span><span class="s2">: L=[</span><span class="si">{</span><span class="n">L</span><span class="o">.</span><span class="n">min</span><span class="p">()</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">L</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">], &quot;</span>
                      <span class="sa">f</span><span class="s2">&quot;mode=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">render_mode</span><span class="si">}</span><span class="s2">, sources=</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">sources</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="c1"># Update movable slice if visible</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">show_slice</span><span class="p">:</span>
                <span class="n">slice_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_prepare_slice_data</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">slice_image</span><span class="o">.</span><span class="n">set_data</span><span class="p">(</span><span class="n">slice_data</span><span class="p">)</span>

            <span class="c1"># Update metrics</span>
            <span class="n">Q</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">get_total_coherence</span><span class="p">()</span>
            <span class="n">C_bio</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">get_consciousness_metric</span><span class="p">()</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">q_label</span><span class="o">.</span><span class="n">setText</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Q: </span><span class="si">{</span><span class="n">Q</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cbio_label</span><span class="o">.</span><span class="n">setText</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;C_bio: </span><span class="si">{</span><span class="n">C_bio</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">time_label</span><span class="o">.</span><span class="n">setText</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;t: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">time</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sources_label</span><span class="o">.</span><span class="n">setText</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Sources: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">sources</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="c1"># Update colors based on values</span>
            <span class="n">q_color</span> <span class="o">=</span> <span class="s2">&quot;#80ffaa&quot;</span> <span class="k">if</span> <span class="n">Q</span> <span class="o">&gt;</span> <span class="mf">1.5</span> <span class="k">else</span> <span class="p">(</span><span class="s2">&quot;#ffff80&quot;</span> <span class="k">if</span> <span class="n">Q</span> <span class="o">&gt;</span> <span class="mf">0.5</span> <span class="k">else</span> <span class="s2">&quot;#ff8080&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">q_label</span><span class="o">.</span><span class="n">setStyleSheet</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;font-size: 14px; color: </span><span class="si">{</span><span class="n">q_color</span><span class="si">}</span><span class="s2">;&quot;</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">update</span><span class="p">()</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">_load_preset</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">preset</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot;Load a preset configuration.&quot;&quot;&quot;</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[DEBUG] _load_preset called with preset=&#39;</span><span class="si">{</span><span class="n">preset</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">preset</span> <span class="o">==</span> <span class="s1">&#39;healthy&#39;</span><span class="p">:</span>
                <span class="n">create_healthy_preset</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">preset</span> <span class="o">==</span> <span class="s1">&#39;pathology&#39;</span><span class="p">:</span>
                <span class="n">create_pathology_preset</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">preset</span> <span class="o">==</span> <span class="s1">&#39;healing&#39;</span><span class="p">:</span>
                <span class="n">create_healing_preset</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="p">)</span>

            <span class="c1"># Warm up the simulation so field is immediately visible</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[DEBUG] Running 50 warm-up steps...&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">step</span><span class="p">(</span><span class="mi">50</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[DEBUG] After warm-up: L range=[</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">L</span><span class="o">.</span><span class="n">min</span><span class="p">()</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">L</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">], &quot;</span>
                  <span class="sa">f</span><span class="s2">&quot;sources=</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">sources</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">_set_mode</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mode</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot;Set interaction mode.&quot;&quot;&quot;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">mode</span> <span class="o">=</span> <span class="n">mode</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">btn_source</span><span class="o">.</span><span class="n">setChecked</span><span class="p">(</span><span class="n">mode</span> <span class="o">==</span> <span class="s1">&#39;add_source&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">btn_perturb</span><span class="o">.</span><span class="n">setChecked</span><span class="p">(</span><span class="n">mode</span> <span class="o">==</span> <span class="s1">&#39;perturbation&#39;</span><span class="p">)</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">_update_vl</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot;Update v_L from slider.&quot;&quot;&quot;</span>
            <span class="n">v</span> <span class="o">=</span> <span class="n">value</span> <span class="o">/</span> <span class="mf">100.0</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">v_L</span> <span class="o">=</span> <span class="n">v</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">dt</span> <span class="o">=</span> <span class="mf">0.4</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">dx</span> <span class="o">/</span> <span class="p">(</span><span class="n">v</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">3</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">vl_value</span><span class="o">.</span><span class="n">setText</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">v</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">_update_kappa</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot;Update kappa_L from slider.&quot;&quot;&quot;</span>
            <span class="n">k</span> <span class="o">=</span> <span class="n">value</span> <span class="o">/</span> <span class="mf">10.0</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">kappa_L</span> <span class="o">=</span> <span class="n">k</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">kappa_value</span><span class="o">.</span><span class="n">setText</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">k</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">_update_speed</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot;Update animation speed.&quot;&quot;&quot;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">steps_per_frame</span> <span class="o">=</span> <span class="n">value</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">speed_value</span><span class="o">.</span><span class="n">setText</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">))</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">_toggle_slice</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="p">):</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot;Toggle slice visibility.&quot;&quot;&quot;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">show_slice</span> <span class="o">=</span> <span class="n">state</span> <span class="o">==</span> <span class="n">QtCore</span><span class="o">.</span><span class="n">Qt</span><span class="o">.</span><span class="n">Checked</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">slice_image</span><span class="o">.</span><span class="n">visible</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">show_slice</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">_update_slice_position</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot;Update slice position.&quot;&quot;&quot;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">slice_index</span> <span class="o">=</span> <span class="n">value</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">slice_pos_label</span><span class="o">.</span><span class="n">setText</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">))</span>

            <span class="c1"># Update slice transform</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">slice_image</span><span class="o">.</span><span class="n">transform</span> <span class="o">=</span> <span class="n">STTransform</span><span class="p">(</span>
                <span class="n">translate</span><span class="o">=</span><span class="p">(</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">grid_size</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">grid_size</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="n">value</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">grid_size</span><span class="o">/</span><span class="mi">2</span><span class="p">),</span>
                <span class="n">scale</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
            <span class="p">)</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">_toggle_play</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot;Toggle play/pause.&quot;&quot;&quot;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">running</span> <span class="o">=</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">running</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">btn_play</span><span class="o">.</span><span class="n">setText</span><span class="p">(</span><span class="s2">&quot;▶ Play&quot;</span> <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">running</span> <span class="k">else</span> <span class="s2">&quot;⏸ Pause&quot;</span><span class="p">)</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">_clear</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot;Clear sources but keep simulation running.&quot;&quot;&quot;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">clear_sources</span><span class="p">()</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">_reset</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot;Reset entire simulation.&quot;&quot;&quot;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">reset</span><span class="p">()</span>
            <span class="n">create_healthy_preset</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">step</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span>  <span class="c1"># Warm up so field is immediately visible</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">_on_mouse_press</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">event</span><span class="p">):</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot;Handle mouse press - store position for click vs drag detection.&quot;&quot;&quot;</span>
            <span class="c1"># Store press position for all buttons</span>
            <span class="k">if</span> <span class="n">event</span><span class="o">.</span><span class="n">button</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">]:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_mouse_press_pos</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="n">pos</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">_on_mouse_release</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">event</span><span class="p">):</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot;Handle mouse release - add source only if it was a click (not drag).&quot;&quot;&quot;</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mouse_press_pos</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">return</span>

            <span class="c1"># Calculate movement distance</span>
            <span class="n">dx</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="n">pos</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mouse_press_pos</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">dy</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="n">pos</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mouse_press_pos</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">distance</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">dx</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">dy</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>

            <span class="c1"># Only add source if movement was below threshold (a &quot;click&quot;, not a drag)</span>
            <span class="k">if</span> <span class="n">distance</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">_click_threshold</span> <span class="ow">and</span> <span class="n">event</span><span class="o">.</span><span class="n">button</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">]:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[DEBUG] Click detected (moved </span><span class="si">{</span><span class="n">distance</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">px &lt; </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_click_threshold</span><span class="si">}</span><span class="s2">px threshold)&quot;</span><span class="p">)</span>
                <span class="n">pos_3d</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_screen_to_world</span><span class="p">(</span><span class="n">event</span><span class="o">.</span><span class="n">pos</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">pos_3d</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_add_interaction_at</span><span class="p">(</span><span class="n">pos_3d</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">pos_3d</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">pos_3d</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[DEBUG] Drag detected (moved </span><span class="si">{</span><span class="n">distance</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">px) - no source added&quot;</span><span class="p">)</span>

            <span class="c1"># Clear press position</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_mouse_press_pos</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">_screen_to_world</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">screen_pos</span><span class="p">):</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot;Convert screen coordinates to world coordinates on the XY plane (z=0).&quot;&quot;&quot;</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="c1"># Get the transform from the view</span>
                <span class="n">tr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">view</span><span class="o">.</span><span class="n">scene</span><span class="o">.</span><span class="n">transform</span>

                <span class="c1"># Create a ray from the camera through the click point</span>
                <span class="c1"># Map screen position to normalized device coordinates</span>
                <span class="n">pos</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="n">screen_pos</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">screen_pos</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span>
                                <span class="p">[</span><span class="n">screen_pos</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">screen_pos</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>

                <span class="c1"># Transform to world coordinates</span>
                <span class="c1"># Use the inverse of the scene transform</span>
                <span class="n">world_pos</span> <span class="o">=</span> <span class="n">tr</span><span class="o">.</span><span class="n">imap</span><span class="p">(</span><span class="n">pos</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">world_pos</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">world_pos</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="p">:</span>
                    <span class="c1"># Get ray direction</span>
                    <span class="n">p0</span> <span class="o">=</span> <span class="n">world_pos</span><span class="p">[</span><span class="mi">0</span><span class="p">][:</span><span class="mi">3</span><span class="p">]</span> <span class="o">/</span> <span class="n">world_pos</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">3</span><span class="p">]</span> <span class="k">if</span> <span class="n">world_pos</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">3</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span> <span class="k">else</span> <span class="n">world_pos</span><span class="p">[</span><span class="mi">0</span><span class="p">][:</span><span class="mi">3</span><span class="p">]</span>
                    <span class="n">p1</span> <span class="o">=</span> <span class="n">world_pos</span><span class="p">[</span><span class="mi">1</span><span class="p">][:</span><span class="mi">3</span><span class="p">]</span> <span class="o">/</span> <span class="n">world_pos</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">3</span><span class="p">]</span> <span class="k">if</span> <span class="n">world_pos</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">3</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span> <span class="k">else</span> <span class="n">world_pos</span><span class="p">[</span><span class="mi">1</span><span class="p">][:</span><span class="mi">3</span><span class="p">]</span>

                    <span class="c1"># Find intersection with z=0 plane</span>
                    <span class="n">direction</span> <span class="o">=</span> <span class="n">p1</span> <span class="o">-</span> <span class="n">p0</span>
                    <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">direction</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mf">1e-6</span><span class="p">:</span>
                        <span class="n">t</span> <span class="o">=</span> <span class="o">-</span><span class="n">p0</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">/</span> <span class="n">direction</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
                        <span class="n">intersection</span> <span class="o">=</span> <span class="n">p0</span> <span class="o">+</span> <span class="n">t</span> <span class="o">*</span> <span class="n">direction</span>

                        <span class="c1"># Convert from grid coordinates to physical coordinates</span>
                        <span class="n">scale</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">L_domain</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">grid_size</span>
                        <span class="n">x</span> <span class="o">=</span> <span class="n">intersection</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">scale</span>
                        <span class="n">y</span> <span class="o">=</span> <span class="n">intersection</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">scale</span>
                        <span class="n">z</span> <span class="o">=</span> <span class="mi">0</span>  <span class="c1"># On the XY plane</span>

                        <span class="c1"># Clamp to domain</span>
                        <span class="n">half</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">L_domain</span> <span class="o">/</span> <span class="mi">2</span>
                        <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="o">-</span><span class="n">half</span> <span class="o">*</span> <span class="mf">0.9</span><span class="p">,</span> <span class="n">half</span> <span class="o">*</span> <span class="mf">0.9</span><span class="p">)</span>
                        <span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="o">-</span><span class="n">half</span> <span class="o">*</span> <span class="mf">0.9</span><span class="p">,</span> <span class="n">half</span> <span class="o">*</span> <span class="mf">0.9</span><span class="p">)</span>

                        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[DEBUG] Screen (</span><span class="si">{</span><span class="n">screen_pos</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">:</span><span class="s2">.0f</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">screen_pos</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">:</span><span class="s2">.0f</span><span class="si">}</span><span class="s2">) -&gt; &quot;</span>
                              <span class="sa">f</span><span class="s2">&quot;World (</span><span class="si">{</span><span class="n">x</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">y</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">z</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
                        <span class="k">return</span> <span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[DEBUG] Screen to world conversion failed: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="c1"># Fallback: random position near center</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;[DEBUG] Using fallback random position&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="mi">0</span><span class="p">)</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">_on_key_press</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">event</span><span class="p">):</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot;Handle key press for adding sources/perturbations and mode changes.&quot;&quot;&quot;</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[DEBUG] Key press: key=</span><span class="si">{</span><span class="n">event</span><span class="o">.</span><span class="n">key</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">event</span><span class="o">.</span><span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;S&#39;</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;[DEBUG] &#39;S&#39; key pressed - adding source at random position&quot;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_set_mode</span><span class="p">(</span><span class="s1">&#39;add_source&#39;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_add_interaction_at_random</span><span class="p">()</span>
            <span class="k">elif</span> <span class="n">event</span><span class="o">.</span><span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;P&#39;</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;[DEBUG] &#39;P&#39; key pressed - adding perturbation at random position&quot;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_set_mode</span><span class="p">(</span><span class="s1">&#39;perturbation&#39;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_add_interaction_at_random</span><span class="p">()</span>
            <span class="k">elif</span> <span class="n">event</span><span class="o">.</span><span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;T&#39;</span><span class="p">:</span>
                <span class="c1"># Test: inject a test pattern to verify rendering</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;[DEBUG] &#39;T&#39; key pressed - injecting test pattern&quot;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_inject_test_pattern</span><span class="p">()</span>
            <span class="k">elif</span> <span class="n">event</span><span class="o">.</span><span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;V&#39;</span><span class="p">:</span>
                <span class="c1"># Cycle through render modes: slices -&gt; volume -&gt; isosurface -&gt; slices</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;[DEBUG] &#39;V&#39; key pressed - cycling render mode&quot;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_cycle_render_mode</span><span class="p">()</span>
            <span class="k">elif</span> <span class="n">event</span><span class="o">.</span><span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;R&#39;</span><span class="p">:</span>
                <span class="c1"># Reset camera to default view</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;[DEBUG] &#39;R&#39; key pressed - resetting camera&quot;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_reset_camera</span><span class="p">()</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">_reset_camera</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot;Reset camera to default viewing position.&quot;&quot;&quot;</span>
            <span class="n">N</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">grid_size</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">view</span><span class="o">.</span><span class="n">camera</span><span class="o">.</span><span class="n">distance</span> <span class="o">=</span> <span class="n">N</span> <span class="o">*</span> <span class="mf">1.5</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">view</span><span class="o">.</span><span class="n">camera</span><span class="o">.</span><span class="n">elevation</span> <span class="o">=</span> <span class="mi">30</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">view</span><span class="o">.</span><span class="n">camera</span><span class="o">.</span><span class="n">azimuth</span> <span class="o">=</span> <span class="mi">45</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[DEBUG] Camera reset: distance=</span><span class="si">{</span><span class="n">N</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mf">1.5</span><span class="si">}</span><span class="s2">, elevation=30, azimuth=45&quot;</span><span class="p">)</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">_add_interaction_at_random</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot;Add a source or perturbation at a random location.&quot;&quot;&quot;</span>
            <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
            <span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
            <span class="n">z</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_add_interaction_at</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span><span class="p">)</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">_add_interaction_at</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">z</span><span class="p">:</span> <span class="nb">float</span><span class="p">):</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot;Add a source or perturbation at the specified position.&quot;&quot;&quot;</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[DEBUG] Adding </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">mode</span><span class="si">}</span><span class="s2"> at (</span><span class="si">{</span><span class="n">x</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">y</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">z</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mode</span> <span class="o">==</span> <span class="s1">&#39;add_source&#39;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">add_source</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span><span class="p">,</span> <span class="n">strength</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">frequency</span><span class="o">=</span><span class="mf">1.5</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">add_perturbation</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span><span class="p">,</span> <span class="n">strength</span><span class="o">=</span><span class="mf">2.5</span><span class="p">,</span> <span class="n">radius</span><span class="o">=</span><span class="mf">1.5</span><span class="p">)</span>
            <span class="c1"># Immediately update markers</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_update_source_markers</span><span class="p">()</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">_inject_test_pattern</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot;Inject a test pattern directly into the field to verify rendering.&quot;&quot;&quot;</span>
            <span class="c1"># Create a simple sphere pattern</span>
            <span class="n">coords</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">L_domain</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">L_domain</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">N</span><span class="p">)</span>
            <span class="n">X</span><span class="p">,</span> <span class="n">Y</span><span class="p">,</span> <span class="n">Z</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span><span class="n">coords</span><span class="p">,</span> <span class="n">coords</span><span class="p">,</span> <span class="n">coords</span><span class="p">,</span> <span class="n">indexing</span><span class="o">=</span><span class="s1">&#39;ij&#39;</span><span class="p">)</span>
            <span class="n">dist</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">X</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">Y</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">Z</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>

            <span class="c1"># Inject sphere: max at center (0), fading outward</span>
            <span class="n">radius</span> <span class="o">=</span> <span class="mf">3.0</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">L</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="mf">1.0</span> <span class="o">-</span> <span class="n">dist</span><span class="o">/</span><span class="n">radius</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[DEBUG] Test pattern injected: L range=[</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">L</span><span class="o">.</span><span class="n">min</span><span class="p">()</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">L</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">]&quot;</span><span class="p">)</span>


<span class="k">def</span><span class="w"> </span><span class="nf">demo</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Run the real-time 3D Loomfield visualizer.&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">HAS_VISPY</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">HAS_QT</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="s2">&quot;=&quot;</span> <span class="o">*</span> <span class="mi">60</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;  MISSING DEPENDENCIES&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=&quot;</span> <span class="o">*</span> <span class="mi">60</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">The real-time 3D visualizer requires vispy and PyQt5.&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Install with:&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;  pip install vispy PyQt5&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Alternatively, use the plotly-based visualizer:&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;  python run_loomfield_3d_demo.py&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=&quot;</span> <span class="o">*</span> <span class="mi">60</span><span class="p">)</span>
        <span class="k">return</span>

    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=&quot;</span> <span class="o">*</span> <span class="mi">60</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;  COSMIC LOOM THEORY: Real-Time 3D Loomfield Simulator&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=&quot;</span> <span class="o">*</span> <span class="mi">60</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">Starting real-time 3D visualization...</span>

<span class="s2">CONTROLS:</span>
<span class="s2">  • LEFT CLICK on slice plane to add source/perturbation</span>
<span class="s2">  • Drag to rotate view</span>
<span class="s2">  • Scroll to zoom in/out</span>
<span class="s2">  • &#39;V&#39; key = toggle render mode (Slices &lt;-&gt; Isosurface)</span>
<span class="s2">  • &#39;R&#39; key = reset camera view</span>
<span class="s2">  • &#39;S&#39; key = add source at random position</span>
<span class="s2">  • &#39;P&#39; key = add perturbation at random position</span>
<span class="s2">  • Use preset buttons to load scenarios</span>
<span class="s2">  • Toggle between Add Source / Perturbation modes</span>
<span class="s2">  • White markers show source locations</span>

<span class="s2">RENDER MODES:</span>
<span class="s2">  • Slices: 3 orthogonal slice planes (fast, shows interior)</span>
<span class="s2">  • Isosurface: Nested transparent shells (3D structure)</span>
<span class="s2">    &quot;&quot;&quot;</span><span class="p">)</span>

    <span class="c1"># Create Qt application</span>
    <span class="n">qt_app</span> <span class="o">=</span> <span class="n">QtWidgets</span><span class="o">.</span><span class="n">QApplication</span><span class="p">([])</span>
    <span class="n">qt_app</span><span class="o">.</span><span class="n">setStyle</span><span class="p">(</span><span class="s1">&#39;Fusion&#39;</span><span class="p">)</span>

    <span class="c1"># Create and show visualizer</span>
    <span class="n">viz</span> <span class="o">=</span> <span class="n">Loomfield3DVisualizer</span><span class="p">(</span><span class="n">grid_size</span><span class="o">=</span><span class="mi">32</span><span class="p">)</span>
    <span class="n">viz</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

    <span class="c1"># Run event loop</span>
    <span class="n">qt_app</span><span class="o">.</span><span class="n">exec_</span><span class="p">()</span>


<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="n">demo</span><span class="p">()</span>
</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2025, Rex Fraterne &amp; Seraphina AI.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>